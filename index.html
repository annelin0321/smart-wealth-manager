import React, { useState, useMemo, useEffect } from 'react';
import { Plus, Trash2, Save, Calendar, DollarSign, Wallet, TrendingUp, History, ArrowRight, AlertCircle, CheckCircle2, HelpCircle, FileText, ArrowLeft, ClipboardList, Activity, LayoutDashboard, CheckSquare, Square, ShieldAlert, Gift, Cloud, PiggyBank, PieChart, BookOpen, Download, Calculator, CreditCard } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc } from 'firebase/firestore';

// ==========================================
// Firebase åˆå§‹åŒ–
// ==========================================<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½è²¡å‹™ç®¡å®¶</title>
  
  <!-- è¼‰å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- è¨­å®š ESM æ¨¡çµ„å°æ‡‰ (Import Map)ï¼Œè®“ç€è¦½å™¨å¯ä»¥ç›´æ¥å¾é›²ç«¯è¼‰å…¥ React èˆ‡ Firebase -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://esm.sh/firebase@10.8.0/app",
        "firebase/auth": "https://esm.sh/firebase@10.8.0/auth",
        "firebase/firestore": "https://esm.sh/firebase@10.8.0/firestore"
      }
    }
  </script>
  
  <!-- è¼‰å…¥ Babelï¼Œè®“ç€è¦½å™¨èƒ½å³æ™‚è§£æ React çš„ JSX èªæ³• -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root">
    <!-- ç¶²é è¼‰å…¥æ™‚çš„éæ¸¡ç•«é¢ -->
    <div class="flex items-center justify-center min-h-screen text-gray-400 font-bold text-lg tracking-widest">
      ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...
    </div>
  </div>

  <!-- React æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒç¨‹å¼ç¢¼ -->
  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Plus, Trash2, Save, Calendar, DollarSign, Wallet, TrendingUp, History, ArrowRight, AlertCircle, CheckCircle2, HelpCircle, FileText, ArrowLeft, ClipboardList, Activity, LayoutDashboard, CheckSquare, Square, ShieldAlert, Gift, Cloud, PiggyBank, PieChart, BookOpen, Download, Calculator, CreditCard } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc } from 'firebase/firestore';

    // ==========================================
    // Firebase åˆå§‹åŒ– (è«‹å¡«å¯«æ‚¨çš„å°ˆæ¡ˆè¨­å®š)
    // ==========================================
    const firebaseConfig = {
      apiKey: "è«‹è²¼ä¸Šæ‚¨çš„ apiKey",
      authDomain: "è«‹è²¼ä¸Šæ‚¨çš„ authDomain",
      projectId: "è«‹è²¼ä¸Šæ‚¨çš„ projectId",
      storageBucket: "è«‹è²¼ä¸Šæ‚¨çš„ storageBucket",
      messagingSenderId: "è«‹è²¼ä¸Šæ‚¨çš„ messagingSenderId",
      appId: "è«‹è²¼ä¸Šæ‚¨çš„ appId"
    };

    let app, auth, db;
    const appId = 'my-finance-hub'; // æ‚¨çš„æ‡‰ç”¨ç¨‹å¼å°ˆå±¬ ID

    try {
      // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç¶“å¡«å¯«äº† API Key (é¿å…é è¨­æ–‡å­—å°è‡´å ±éŒ¯)
      if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("è«‹è²¼ä¸Š")) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase é›²ç«¯è³‡æ–™åº«å·²é€£ç·šï¼");
      } else {
        console.warn("å°šæœªè¨­å®š Firebaseï¼Œç›®å‰ä»¥ã€Œå–®æ©Ÿæ¸¬è©¦æ¨¡å¼ã€é‹è¡Œï¼ˆé—œé–‰ç¶²é å¾Œè³‡æ–™å°‡éºå¤±ï¼‰ã€‚è«‹è‡³ç¨‹å¼ç¢¼å¡«å¯«æ‚¨çš„ firebaseConfigã€‚");
      }
    } catch (error) {
      console.error("Firebase init failed:", error);
    }

    // ==========================================
    // å…±ç”¨è¡¨æ ¼å…ƒä»¶
    // ==========================================
    const SelectableTable = ({ title, items, setter, colorClass, handleUpdate, handleDelete, handleAdd }) => (
      <div className={`bg-white rounded-xl shadow-sm border ${colorClass} overflow-hidden flex flex-col`}>
        <div className={`px-4 py-2 font-bold text-center border-b ${colorClass.replace('border-', 'bg-').replace('-200', '-100')} text-gray-800`}>
          {title}
        </div>
        <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
          <div className="w-2/5 p-2 text-center border-r border-gray-200">æ”¯å‡ºé …ç›®</div>
          <div className="w-2/5 p-2 text-center border-r border-gray-200">é ä¼°é‡‘é¡</div>
          <div className="w-1/5 p-2 text-center">è¨ˆå…¥åº•ç·š</div>
        </div>
        <div className="flex-1 p-2 space-y-2">
          {items.map(item => (
            <div key={item.id} className="flex items-center gap-2 group relative">
              <input type="text" value={item.name} onChange={e => handleUpdate(setter, item.id, 'name', e.target.value)} className="w-2/5 p-1.5 text-sm border rounded focus:ring-1 bg-transparent" placeholder="é …ç›®"/>
              <input type="number" value={item.amount} onChange={e => handleUpdate(setter, item.id, 'amount', e.target.value)} className="w-2/5 p-1.5 text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="é‡‘é¡"/>
              <button onClick={() => handleUpdate(setter, item.id, 'included', !item.included)} className={`w-1/5 flex justify-center items-center transition-colors ${item.included ? 'text-pink-600' : 'text-gray-300 hover:text-pink-300'}`}>
                {item.included ? <CheckSquare size={20}/> : <Square size={20}/>}
              </button>
              <button onClick={() => handleDelete(setter, item.id)} className="absolute -left-6 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity"><Trash2 size={14}/></button>
            </div>
          ))}
          <button onClick={() => handleAdd(setter)} className="w-full py-1.5 text-xs text-gray-400 hover:text-pink-600 bg-gray-50 rounded transition-colors flex justify-center items-center gap-1"><Plus size={14}/> æ–°å¢é …ç›®</button>
        </div>
      </div>
    );

    const ArrayTable = ({ title, columns, items, setter, totalLabel, totalValue, defaultNewObj, handleUpdateArr, handleDelArr, handleAddArr }) => (
      <div className="border border-gray-200 rounded-lg overflow-hidden flex flex-col bg-white shadow-sm hover:shadow-md transition-shadow">
        <div className="bg-gray-100 px-4 py-2 font-bold text-gray-800 text-center border-b border-gray-200 text-sm md:text-base">{title}</div>
        <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
           {columns.map((col, i) => <div key={i} className={`p-2 text-center border-r border-gray-200 last:border-0 ${col.width}`}>{col.label}</div>)}
        </div>
        <div className="flex-1">
           {items.map((item) => (
             <div key={item.id} className="flex border-b border-gray-100 last:border-0 group relative hover:bg-purple-50/30">
               {columns.map((col, i) => (
                  <div key={i} className={`p-1 border-r border-gray-100 last:border-0 flex items-center justify-center ${col.width}`}>
                     {col.render(item, (val) => handleUpdateArr(setter, item.id, col.field, val))}
                  </div>
               ))}
               <button onClick={() => handleDelArr(setter, item.id)} className="absolute -right-6 md:-right-8 top-1/2 -translate-y-1/2 p-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14}/></button>
             </div>
           ))}
        </div>
        <div className="p-1 border-b border-gray-100">
           <button onClick={() => handleAddArr(setter, defaultNewObj)} className="w-full py-1.5 text-xs text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors flex items-center justify-center gap-1"><Plus size={14} /> æ–°å¢åˆ—</button>
        </div>
        {totalLabel && (
           <div className="flex bg-purple-50 font-bold text-sm">
              <div className="flex-1 p-2 text-center text-purple-800 border-r border-purple-100">{totalLabel}</div>
              <div className="flex-1 p-2 text-center text-purple-800">${totalValue.toLocaleString()}</div>
           </div>
        )}
      </div>
    );

    const ExpenseTable = ({ title, items, setter, total, icon: Icon, colorClass, handleUpdateItem, handleDeleteItem, handleAddItem, accounts }) => (
      <div className={`bg-white rounded-xl shadow-sm border ${colorClass} overflow-hidden`}>
        <div className={`px-4 py-3 border-b flex items-center justify-between ${colorClass.replace('border-', 'bg-').replace('-200', '-50')}`}>
          <h3 className="font-bold flex items-center gap-2 text-gray-800"><Icon size={18} className="text-gray-600" />{title}</h3>
          <span className="font-bold text-gray-800">${total.toLocaleString()}</span>
        </div>
        <div className="p-2">
          {items.map((item) => (
            <div key={item.id} className="flex gap-2 mb-2 items-center">
              <input type="text" placeholder="é …ç›®åç¨±" value={item.name} onChange={(e) => handleUpdateItem(setter, item.id, 'name', e.target.value)} className="flex-1 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300"/>
              
              <select 
                value={item.account || ''} 
                onChange={(e) => handleUpdateItem(setter, item.id, 'account', e.target.value)} 
                className="w-24 md:w-32 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300 bg-white text-gray-700"
              >
                <option value="" className="text-gray-400">è«‹é¸æ“‡å¸³æˆ¶</option>
                {accounts.map(acc => <option key={acc.id} value={acc.name}>{acc.name}</option>)}
              </select>

              <input type="number" placeholder="é‡‘é¡" value={item.amount === 0 ? 0 : (item.amount || '')} onChange={(e) => handleUpdateItem(setter, item.id, 'amount', e.target.value === '' ? '' : Number(e.target.value))} className="w-24 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300"/>
              <button onClick={() => handleDeleteItem(setter, item.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={16} /></button>
            </div>
          ))}
          <button onClick={() => handleAddItem(setter)} className="w-full py-2 mt-1 text-sm text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg flex items-center justify-center gap-1 transition-colors"><Plus size={16} /> æ–°å¢é …ç›®</button>
        </div>
      </div>
    );

    const MasterDebtTable = ({ masterDebts, setMasterDebts, setDebts, setFixedExpenses, handleUpdateItem, handleDeleteItem, handleAddItem, totalMasterDebt, accounts }) => (
      <div className="bg-white rounded-xl shadow-sm border border-orange-200 overflow-hidden mb-6">
        <div className="px-4 py-3 border-b bg-orange-50 flex items-center justify-between">
          <div className="flex flex-col">
            <h3 className="font-bold flex items-center gap-2 text-gray-800"><ClipboardList size={18} className="text-gray-600" />å®šæœŸæ‰£æ¬¾èˆ‡å‚µå‹™æ¸…å–® (è‡ªå‹•åˆ†æµ)</h3>
            <span className="text-xs text-gray-500 mt-1">ï¼Šåˆ—å‡ºæ‰€æœ‰å®šæœŸæ‰£æ¬¾ï¼Œé»é¸å³å´ã€Œå…¥è² å‚µã€æˆ–ã€Œå…¥å›ºå®šã€è‡ªå‹•åˆ†é…è‡³ä¸‹æ–¹å€å¡Šã€‚</span>
          </div>
          <div className="text-right">
            <div className="text-xs text-gray-500">ç¸½è¨ˆ</div>
            <span className="font-bold text-gray-800">${totalMasterDebt.toLocaleString()}</span>
          </div>
        </div>
        <div className="p-2 overflow-x-auto">
          <table className="w-full text-sm text-left min-w-[650px]">
            <thead className="text-xs text-gray-500 bg-gray-50">
              <tr>
                <th className="px-2 py-2 w-[22%]">é …ç›®</th><th className="px-2 py-2 w-[18%]">æ‰£æ¬¾å¸³æˆ¶</th><th className="px-2 py-2 w-[15%]">æ¯æœˆæ‡‰ç¹³</th><th className="px-2 py-2 w-[15%]">å‚™è¨» (å¦‚:æœŸæ•¸)</th><th className="px-2 py-2 w-[12%]">æ‰£æ¬¾æ—¥</th><th className="px-2 py-2 text-center">åˆ†é… / åˆªé™¤</th>
              </tr>
            </thead>
            <tbody>
              {masterDebts.map((item) => (
                <tr key={item.id} className="border-b border-gray-50 last:border-0 hover:bg-orange-50/30">
                  <td className="px-1 py-1"><input type="text" placeholder="é …ç›®åç¨±" value={item.name} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'name', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
                  
                  <td className="px-1 py-1">
                    <select value={item.account || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'account', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-white text-gray-700">
                      <option value="" className="text-gray-400">è«‹é¸æ“‡</option>
                      {accounts.map(acc => <option key={acc.id} value={acc.name}>{acc.name}</option>)}
                    </select>
                  </td>

                  <td className="px-1 py-1"><input type="number" placeholder="é‡‘é¡" value={item.amount === 0 ? 0 : (item.amount || '')} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'amount', e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
                  <td className="px-1 py-1"><input type="text" placeholder="å‚™è¨»" value={item.note || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'note', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
                  <td className="px-1 py-1"><input type="text" placeholder="ç¹³æ¬¾æ—¥" value={item.dueDate || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'dueDate', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
                  <td className="px-1 py-1 flex justify-center items-center gap-1">
                    <button onClick={() => { if(!item.name && !item.amount) return; setDebts(prev => [...prev.filter(i=>i.name||i.amount), { id: Date.now(), name: item.name, amount: item.amount, account: item.account }]); setMasterDebts(prev => prev.filter(d => d.id !== item.id)); }} className="px-2 py-1 text-xs bg-red-100 text-red-600 hover:bg-red-200 rounded font-bold transition-colors whitespace-nowrap">å…¥è² å‚µ</button>
                    <button onClick={() => { if(!item.name && !item.amount) return; setFixedExpenses(prev => [...prev.filter(i=>i.name||i.amount), { id: Date.now(), name: item.name, amount: item.amount, account: item.account }]); setMasterDebts(prev => prev.filter(d => d.id !== item.id)); }} className="px-2 py-1 text-xs bg-blue-100 text-blue-600 hover:bg-blue-200 rounded font-bold transition-colors whitespace-nowrap">å…¥å›ºå®š</button>
                    <button onClick={() => handleDeleteItem(setMasterDebts, item.id)} className="p-1 text-gray-400 hover:text-red-600 rounded transition-colors"><Trash2 size={16} /></button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          <button onClick={() => handleAddItem(setMasterDebts, { name: '', amount: 0, note: '', dueDate: '', account: '' })} className="w-full py-2 mt-2 text-sm text-gray-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg flex items-center justify-center gap-1 transition-colors"><Plus size={16} /> æ–°å¢é …ç›®</button>
        </div>
      </div>
    );

    // === ç³»çµ±ä½¿ç”¨èªªæ˜å…ƒä»¶ ===
    const InstructionsView = () => (
      <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-10 space-y-8">
        <div className="text-center mb-8">
          <h2 className="text-2xl md:text-3xl font-bold text-gray-800 tracking-wider flex justify-center items-center gap-2">
            <BookOpen className="text-purple-600" size={28}/> ç³»çµ±æ“ä½œèˆ‡ç†è²¡æŒ‡å—
          </h2>
          <p className="text-gray-500 mt-2">å”åŠ©æ‚¨å»ºç«‹ç©©å¥çš„å€‹äººèˆ‡å®¶åº­è²¡å‹™ç³»çµ±</p>
        </div>

        <div className="space-y-6 text-gray-700 leading-relaxed">
          <section className="bg-blue-50 p-5 rounded-xl border border-blue-100">
            <h3 className="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2"><CreditCard size={20}/> 1. å»ºç«‹å¸³æˆ¶ç¸½è¡¨</h3>
            <ul className="list-disc list-inside space-y-2 ml-2">
              <li><strong>é›†ä¸­åŒ–ç®¡ç†ï¼š</strong>è«‹å…ˆå‰å¾€ã€Œå¸³æˆ¶ç¸½è¡¨ã€åˆ†é ï¼Œå°‡æ‚¨æ‰€æœ‰çš„å­˜æ¬¾éŠ€è¡Œã€é›»å­æ”¯ä»˜(LinePay/æ‚ éŠå¡)ã€è‚¡ç¥¨æˆ¶é ­ã€ç”šè‡³æŠ¼é‡‘èˆ‡æ‡‰æ”¶æ¬¾å»ºç«‹ä¸Šå»ï¼Œä¸¦å¡«å…¥ç›®å‰çš„çœŸå¯¦é¤˜é¡ã€‚</li>
              <li><strong>è‡ªå‹•é€£å‹•ï¼š</strong>å»ºç«‹å¥½å¾Œï¼Œå…¶ä»–åˆ†é çš„è¡¨æ ¼éƒ½æœƒè‡ªå‹•é•·å‡ºä¸‹æ‹‰é¸å–®è®“æ‚¨é»é¸ï¼Œå†ä¹Ÿä¸ç”¨æ‰‹å‹•è¼¸å…¥å¸³æˆ¶åç¨±ï¼</li>
            </ul>
          </section>

          <section className="bg-purple-50 p-5 rounded-xl border border-purple-100">
            <h3 className="text-lg font-bold text-purple-900 mb-3 flex items-center gap-2"><LayoutDashboard size={20}/> 2. æ¯æœˆé ç®—åˆ†é…</h3>
            <ul className="list-disc list-inside space-y-2 ml-2">
              <li><strong>è™›æ“¬ä¿¡å°æ³•ï¼š</strong>å¡«å¯«å„é …æ”¶æ”¯æ™‚ï¼Œé€éä¸‹æ‹‰é¸å–®æŒ‡å®šè³‡é‡‘æµå‹•çš„å¸³æˆ¶ã€‚ç³»çµ±æœƒåœ¨å·¦ä¸‹æ–¹è‡ªå‹•å¹«æ‚¨è¨ˆç®—æ¯å€‹å¸³æˆ¶çš„ã€Œé è¨ˆæ·¨è®Šå‹•ã€èˆ‡ã€Œçµç®—å¾Œçš„å³æ™‚é¤˜é¡ã€ã€‚</li>
              <li><strong>æ ¸å¿ƒåˆ†é…é‚è¼¯ï¼š</strong>ç³»çµ±æ¡ç”¨é›¶åŸºé ç®—æ¦‚å¿µï¼Œä»¥ã€Œç¸½æ”¶å…¥ - è² å‚µ - å›ºå®šæ”¯å‡º - æŠ•è³‡ç†è²¡ = å¯ç”¨è³‡é‡‘ã€ï¼Œä¸¦ä¾æ“šæ‚¨è¨­å®šçš„å„²è“„æ¯”ä¾‹ï¼Œè‡ªå‹•è¨ˆç®—å‡ºã€Œæœ¬æœˆæ‡‰å­˜é‡‘é¡ã€èˆ‡å‰©é¤˜çš„ã€Œç”Ÿæ´»è²»é¡åº¦ã€ã€‚</li>
            </ul>
          </section>

          <section className="bg-pink-50 p-5 rounded-xl border border-pink-100">
            <h3 className="text-lg font-bold text-pink-900 mb-3 flex items-center gap-2"><ShieldAlert size={20}/> 3. è²¡å‹™å®‰å…¨ç¶² (é å‚™é‡‘è©¦ç®—)</h3>
            <ul className="list-disc list-inside space-y-2 ml-2">
              <li><strong>è©•ä¼°æœ€ä½ç”Ÿæ´»åº•ç·šï¼š</strong>åˆ—å‡ºæ—¥å¸¸é–‹éŠ·å¾Œï¼Œ<strong>åƒ…å‹¾é¸ã€Œä¸å¯ä¸­æ–·ã€èˆ‡ã€Œç¶­æŒåŸºæœ¬ç”Ÿæ´»å¿…éœ€ã€</strong>çš„é …ç›®ã€‚</li>
              <li><strong>è‡ªå‹•è©¦ç®—ç›®æ¨™ï¼š</strong>ç³»çµ±æœƒä¾æ“šå‹¾é¸é …ç›®è¨ˆç®—ã€Œæ¯æœˆåŸºæœ¬ç”Ÿæ´»åº•ç·šã€ï¼Œä¸¦è‡ªå‹•æ¨ç®—å‡º 6 å€‹æœˆçš„å®‰å…¨æº–å‚™é‡‘ç›®æ¨™é‡‘é¡ã€‚</li>
            </ul>
          </section>

          <section className="bg-yellow-50 p-5 rounded-xl border border-yellow-100">
            <h3 className="text-lg font-bold text-yellow-900 mb-3 flex items-center gap-2"><Gift size={20}/> 4. é¡å¤–æ”¶å…¥ / çé‡‘è¦åŠƒ</h3>
            <ul className="list-disc list-inside space-y-2 ml-2">
              <li><strong>ç„¡ç¸«åŒ¯å…¥ä¸»è¡¨ï¼š</strong>è¦åŠƒå®Œæˆå¾Œï¼Œé»æ“Šã€ŒåŒ¯å…¥æœ¬æœˆé ç®—è¡¨ã€ï¼Œç³»çµ±æœƒå°‡çé‡‘è½‰ç‚ºå°ˆæ¬¾å°ˆç”¨é …ç›®è‡ªå‹•æ‰£é™¤ï¼Œç¢ºä¿ä¸æœƒå¹²æ“¾æ‚¨æ—¥å¸¸çš„ç”Ÿæ´»è²»æ¯”ä¾‹ã€‚</li>
            </ul>
          </section>

          <section className="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
            <h3 className="text-lg font-bold text-indigo-900 mb-3 flex items-center gap-2"><Activity size={20}/> 5. è²¡å‹™è¿½è¹¤èˆ‡æ­·å²ç´€éŒ„</h3>
            <ul className="list-disc list-inside space-y-2 ml-2">
              <li><strong>è³‡ç”¢è² å‚µç›¤é»ï¼š</strong>åœ¨ã€Œè²¡å‹™è¿½è¹¤ã€ä¸­å¡«å¯«æœŸåˆèˆ‡æœŸæœ«é¤˜é¡ï¼Œç³»çµ±æœƒè‡ªå‹•çµç®—æœ¬æœŸçš„ã€Œæ·¨è³‡ç”¢æˆé•·ã€ã€‚</li>
              <li><strong>å€é–“æ”¶æ”¯è‡ªå‹•åŠ ç¸½ï¼š</strong>åˆ©ç”¨ä¸Šæ–¹çš„ã€Œè‡ªå‹•çµç®—å€é–“è³‡æ–™ã€å·¥å…·ï¼Œé¸æ“‡æœˆä»½å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å°‡æ­·å²çµç®—ç´€éŒ„çš„æ•¸å­—åŠ ç¸½ä¸¦å¡«å…¥å³å´è¡¨æ ¼ä¸­ï¼</li>
            </ul>
          </section>
        </div>
      </div>
    );

    // === ç·Šæ€¥é å‚™é‡‘è¨ˆç®—å…ƒä»¶ ===
    const EmergencyFundView = ({ db, user, appId }) => {
      const [isLoaded, setIsLoaded] = useState(false);
      const [recordName, setRecordName] = useState(() => `${new Date().getFullYear()} é å‚™é‡‘è©•ä¼°`);
      const [savedRecords, setSavedRecords] = useState([]);

      const [fixed, setFixed] = useState([{ id: 1, name: '', amount: '', included: false }]);
      const [saving, setSaving] = useState([{ id: 1, name: '', amount: '', included: false }]);
      const [living, setLiving] = useState([{ id: 1, name: '', amount: '', included: false }]);
      const [shortDebt, setShortDebt] = useState([{ id: 1, name: '', amount: '', included: false }]);
      const [longDebt, setLongDebt] = useState([{ id: 1, name: '', amount: '', included: false }]);

      useEffect(() => {
        if (!user || !db) { setIsLoaded(true); return; }
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'emergency');
        getDoc(docRef).then(snap => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.recordName) setRecordName(data.recordName);
            if (data.fixed) setFixed(JSON.parse(data.fixed));
            if (data.saving) setSaving(JSON.parse(data.saving));
            if (data.living) setLiving(JSON.parse(data.living));
            if (data.shortDebt) setShortDebt(JSON.parse(data.shortDebt));
            if (data.longDebt) setLongDebt(JSON.parse(data.longDebt));
          }
          setIsLoaded(true);
        }).catch(() => setIsLoaded(true));

        const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords');
        const unsubscribe = onSnapshot(recordsRef, (snap) => {
          const records = [];
          snap.forEach(d => records.push({ id: d.id, ...d.data() }));
          records.sort((a, b) => b.timestamp - a.timestamp);
          setSavedRecords(records);
        }, (err) => console.error(err));
        return () => unsubscribe();
      }, [user, db, appId]);

      useEffect(() => {
        if (!isLoaded || !user || !db) return;
        const timer = setTimeout(() => {
          const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'emergency');
          setDoc(docRef, { recordName, fixed: JSON.stringify(fixed), saving: JSON.stringify(saving), living: JSON.stringify(living), shortDebt: JSON.stringify(shortDebt), longDebt: JSON.stringify(longDebt) });
        }, 1500);
        return () => clearTimeout(timer);
      }, [recordName, fixed, saving, living, shortDebt, longDebt, isLoaded, user, db, appId]);

      const handleUpdate = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
      const handleAdd = (setter) => setter(prev => [...prev, { id: Date.now(), name: '', amount: '', included: false }]);
      const handleDelete = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

      const sumIncluded = (arr) => arr.filter(item => item.included).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      const sumFixed = sumIncluded(fixed);
      const sumLiving = sumIncluded(living);
      const sumLongDebt = sumIncluded(longDebt);
      const monthStandard = sumFixed + sumLiving + sumLongDebt;
      const halfYearGoal = monthStandard * 6;

      const saveRecord = async () => {
        if (!recordName.trim()) return alert("è«‹è¼¸å…¥è©•ä¼°åç¨±");
        if (savedRecords.some(r => r.recordName === recordName)) {
          if (!window.confirm(`${recordName} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
        }
        const newRecord = { recordName, fixed: JSON.stringify(fixed), saving: JSON.stringify(saving), living: JSON.stringify(living), shortDebt: JSON.stringify(shortDebt), longDebt: JSON.stringify(longDebt), timestamp: Date.now(), halfYearGoal, monthStandard };
        if (user && db) {
          const existing = savedRecords.find(r => r.recordName === recordName);
          const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords');
          try {
            if (existing) await setDoc(doc(colRef, existing.id), newRecord);
            else await setDoc(doc(colRef, `${recordName}-${Date.now()}`), newRecord);
          } catch (e) { console.error(e); }
        } else {
          setSavedRecords(prev => [...prev.filter(r => r.recordName !== recordName), { id: Date.now(), ...newRecord }].sort((a,b) => b.timestamp - a.timestamp));
        }
      };

      const loadRecord = (record) => {
        if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.recordName}ã€å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
        setRecordName(record.recordName); setFixed(JSON.parse(record.fixed)); setSaving(JSON.parse(record.saving)); setLiving(JSON.parse(record.living)); setShortDebt(JSON.parse(record.shortDebt)); setLongDebt(JSON.parse(record.longDebt));
      };

      const deleteRecord = async (id) => {
        if (user && db) {
          try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords', id.toString())); } catch(e) { console.error(e); }
        } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
      };

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-pink-100 p-4 md:p-8 space-y-6">
          <div className="text-center mb-6">
             <h2 className="text-2xl md:text-3xl font-bold text-pink-900 tracking-wider flex justify-center items-center gap-2">
               <ShieldAlert className="text-pink-500" size={28}/> è²¡å‹™å®‰å…¨ç¶² (é å‚™é‡‘è©¦ç®—)
             </h2>
             <p className="text-pink-600 text-sm mt-2">è©•ä¼°æ¯æœˆå¿…é ˆçš„æœ€ä½é–‹éŠ·ï¼Œå»ºæ§‹ç©©å¥çš„è²¡å‹™é˜²è­·ç¶²</p>
          </div>

          <div className="flex flex-wrap gap-4 bg-pink-50 p-4 rounded-xl border border-pink-200 shadow-sm">
            <div className="flex-1 min-w-[200px]">
              <label className="block text-sm font-bold text-pink-900 mb-2 flex items-center gap-1"><Calendar size={18} /> é å‚™é‡‘è©•ä¼°åç¨±</label>
              <input type="text" value={recordName} onChange={(e) => setRecordName(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026å¹´åº¦é å‚™é‡‘ã€æ›å·¥ä½œå¾Œè©•ä¼°" className="w-full p-2.5 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 font-semibold text-gray-800" />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
            <SelectableTable title="å›ºå®šæ”¯å‡º" items={fixed} setter={setFixed} colorClass="border-blue-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
            <SelectableTable title="å„²è“„èˆ‡æŠ•è³‡" items={saving} setter={setSaving} colorClass="border-green-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
            <SelectableTable title="è®Šå‹•ç”Ÿæ´»è²»" items={living} setter={setLiving} colorClass="border-orange-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
            <div className="flex flex-col gap-4 md:gap-6">
              <SelectableTable title="çŸ­æœŸè² å‚µ (1å¹´å…§çµæ¸…)" items={shortDebt} setter={setShortDebt} colorClass="border-red-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
              <SelectableTable title="é•·æœŸè² å‚µ (å¦‚ï¼šæˆ¿è²¸/å­¸è²¸/ä¿¡è²¸)" items={longDebt} setter={setLongDebt} colorClass="border-purple-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
            </div>
          </div>

          <div className="mt-8 bg-pink-50 rounded-xl p-6 border border-pink-200">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="space-y-4 border-b md:border-b-0 md:border-r border-pink-200 pb-4 md:pb-0 md:pr-6">
                <h3 className="font-bold text-pink-900 text-lg border-b border-pink-200 pb-2">æ¯æœˆåŸºæœ¬ç”Ÿæ´»åº•ç·š</h3>
                <div className="flex justify-between items-center text-gray-700"><span>å›ºå®šæ”¯å‡º (æœ‰å‹¾é¸)</span><span>${sumFixed.toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-700"><span>ç”Ÿæ´»é–‹éŠ· (æœ‰å‹¾é¸)</span><span>${sumLiving.toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-700 border-b border-pink-200 pb-2"><span>å‚µå‹™é‚„æ¬¾ (æœ‰å‹¾é¸)</span><span>${sumLongDebt.toLocaleString()}</span></div>
                <div className="flex justify-between items-center font-bold text-xl text-pink-700"><span>æœ€ä½éœ€æ±‚ç¸½è¨ˆ</span><span>${monthStandard.toLocaleString()}</span></div>
              </div>
              <div className="flex flex-col justify-center space-y-4">
                 <div className="bg-white p-4 rounded-lg shadow-sm border border-pink-100">
                   <div className="text-sm text-gray-500 font-bold mb-1">è¨ˆç®—è©•ä¼°æº–å‰‡å»ºè­°ï¼š</div>
                   <ol className="text-xs text-gray-600 list-decimal list-inside space-y-1">
                     <li><span className="text-red-500 font-bold">ä¸å¯ä¸­æ–·</span>çš„å›ºå®šæ”¯å‡ºï¼ˆå¦‚æˆ¿è²¸ã€ç§Ÿé‡‘ã€åŸºæœ¬ä¿éšªï¼‰</li>
                     <li><span className="text-red-500 font-bold">ç¶­æŒç”Ÿå­˜</span>çš„å¿…è¦é–‹éŠ·ï¼ˆå¦‚åŸºæœ¬ä¼™é£Ÿè²»ã€é€šå‹¤è²»ï¼‰</li>
                     <li>éæ€¥è¿«æ€§çš„å¨›æ¨‚ã€è³¼ç‰©æˆ–æŠ•è³‡é …ç›®å»ºè­°å–æ¶ˆå‹¾é¸</li>
                     <li>ç›®æ¨™æº–å‚™é‡‘å»ºè­°å­˜æ”¾åœ¨é«˜æµå‹•æ€§çš„æ´»å­˜å¸³æˆ¶ä¸­</li>
                   </ol>
                 </div>
                 <div className="bg-pink-600 text-white p-4 rounded-xl shadow-md text-center">
                   <div className="text-pink-100 text-sm mb-1">æ¯æœˆæœ€ä½éœ€æ±‚ ${monthStandard.toLocaleString()} Ã— 6å€‹æœˆ =</div>
                   <div className="text-2xl md:text-3xl font-black tracking-wide flex items-center justify-center gap-2">
                     åŠå¹´å®‰å…¨é å‚™é‡‘ ${halfYearGoal.toLocaleString()}
                   </div>
                 </div>
              </div>
            </div>
          </div>

          <button onClick={saveRecord} className="w-full py-4 bg-pink-500 hover:bg-pink-600 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
            <Save size={24} /> å„²å­˜ã€Œ{recordName}ã€è©•ä¼°ç´€éŒ„
          </button>

          {savedRecords.length > 0 && (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-pink-200 mt-8">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-pink-600"/>æ­·å²é å‚™é‡‘è©•ä¼°ç´€éŒ„</h2>
              <div className="space-y-3">
                {savedRecords.map(record => (
                  <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-pink-300 transition-colors">
                    <div>
                      <span className="font-bold text-pink-800 text-lg">{record.recordName}</span>
                      <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()}</div>
                      <div className="text-sm font-bold text-pink-600 mt-1">ç›®æ¨™é‡‘é¡: ${(record.halfYearGoal || 0).toLocaleString()}</div>
                    </div>
                    <div className="flex items-center gap-3 w-full md:w-auto">
                      <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-pink-300 text-pink-700 text-sm font-bold rounded-lg hover:bg-pink-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                      <button onClick={() => deleteRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20} /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // === å¹´çµ‚/çé‡‘åˆ†é…å…ƒä»¶ ===
    const BonusAllocationView = ({ db, user, appId, onImport }) => {
      const [isLoaded, setIsLoaded] = useState(false);
      const [recordName, setRecordName] = useState(() => `${new Date().getFullYear()} çé‡‘è¦åŠƒ`);
      const [savedRecords, setSavedRecords] = useState([]);
      
      const [bonusAmount, setBonusAmount] = useState('');
      const [status, setStatus] = useState('has_debt'); 
      const [allocations, setAllocations] = useState([]);

      useEffect(() => {
        if (!user || !db) { setIsLoaded(true); return; }
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bonus');
        getDoc(docRef).then(snap => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.recordName) setRecordName(data.recordName);
            if (data.bonusAmount !== undefined) setBonusAmount(data.bonusAmount);
            if (data.status) setStatus(data.status);
            if (data.allocations) setAllocations(JSON.parse(data.allocations));
          }
          setIsLoaded(true);
        }).catch(() => setIsLoaded(true));

        const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords');
        const unsubscribe = onSnapshot(recordsRef, (snap) => {
          const records = [];
          snap.forEach(d => records.push({ id: d.id, ...d.data() }));
          records.sort((a, b) => b.timestamp - a.timestamp);
          setSavedRecords(records);
        }, (err) => console.error(err));
        return () => unsubscribe();
      }, [user, db, appId]);

      useEffect(() => {
        if (!isLoaded) return;
        let template = [];
        if (status === 'has_debt') {
          template = [
            { id: 1, name: 'åŠ é€Ÿæ¸…å„Ÿå‚µå‹™', desc: 'å„ªå…ˆè™•ç†é«˜æ¯è² å‚µ(å¦‚å¡å‚µ/ä¿¡è²¸)', amount: '' },
            { id: 2, name: 'é ç•™å¹´åº¦æ”¯å‡º', desc: 'å¹´åº¦ä¿è²»ã€ç¨…é‡‘é ç®—', amount: '' },
            { id: 3, name: 'é©åº¦è‡ªæˆ‘çŠ’è³', desc: 'ææ’¥å°æ¯”ä¾‹ä½œç‚ºçå‹µï¼Œé¿å…å ±å¾©æ€§æ¶ˆè²»', amount: '' },
            { id: 4, name: 'è½‰å…¥å„²è“„', desc: 'å‰©é¤˜è³‡é‡‘è½‰å…¥å­˜æ¬¾', amount: '' },
          ];
        } else if (status === 'no_ef') {
          template = [
            { id: 1, name: 'å»ºç«‹å®‰å…¨å­˜æ¬¾', desc: 'å„ªå…ˆè£œè¶³ç·Šæ€¥é å‚™é‡‘', amount: '' },
            { id: 2, name: 'é ç•™å¹´åº¦æ”¯å‡º', desc: 'å¹´åº¦ä¿è²»ã€ç¨…é‡‘é ç®—', amount: '' },
            { id: 3, name: 'é©åº¦è‡ªæˆ‘çŠ’è³', desc: 'ææ’¥åˆç†æ¯”ä¾‹ä½œç‚ºç”Ÿæ´»èª¿åŠ‘', amount: '' },
          ];
        } else if (status === 'has_ef') {
          template = [
            { id: 1, name: 'æ“´å¤§è³‡ç”¢æŠ•è³‡', desc: 'è½‰å…¥æŠ•è³‡å¸³æˆ¶åŠ é€Ÿè³‡ç”¢ç´¯ç©', amount: '' },
            { id: 2, name: 'å¤§ç­†é ç®—æº–å‚™', desc: 'æ—…éŠåŸºé‡‘ã€å¤§å‹æ¡è³¼', amount: '' },
            { id: 3, name: 'è‡ªæˆ‘æŠ•è³‡èˆ‡çå‹µ', desc: 'é€²ä¿®èª²ç¨‹æˆ–å€‹äººçŠ’è³', amount: '' },
          ];
        }
        if (allocations.length === 0 || allocations[0]?.name !== template[0].name) {
          setAllocations(template);
        }
      }, [status, isLoaded]);

      useEffect(() => {
        if (!isLoaded || !user || !db) return;
        const timer = setTimeout(() => {
          const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bonus');
          setDoc(docRef, { recordName, bonusAmount, status, allocations: JSON.stringify(allocations) });
        }, 1500);
        return () => clearTimeout(timer);
      }, [recordName, bonusAmount, status, allocations, isLoaded, user, db, appId]);

      const saveRecord = async () => {
        if (!recordName.trim()) return alert("è«‹è¼¸å…¥è¦åŠƒåç¨±");
        if (savedRecords.some(r => r.recordName === recordName)) {
          if (!window.confirm(`${recordName} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
        }
        const newRecord = { recordName, bonusAmount, status, allocations: JSON.stringify(allocations), timestamp: Date.now() };
        if (user && db) {
          const existing = savedRecords.find(r => r.recordName === recordName);
          const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords');
          try {
            if (existing) await setDoc(doc(colRef, existing.id), newRecord);
            else await setDoc(doc(colRef, `${recordName}-${Date.now()}`), newRecord);
          } catch (e) { console.error(e); }
        } else {
          setSavedRecords(prev => [...prev.filter(r => r.recordName !== recordName), { id: Date.now(), ...newRecord }].sort((a,b) => b.timestamp - a.timestamp));
        }
      };

      const loadRecord = (record) => {
        if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.recordName}ã€å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
        setRecordName(record.recordName); setBonusAmount(record.bonusAmount); setStatus(record.status); setAllocations(JSON.parse(record.allocations));
      };

      const deleteRecord = async (id) => {
        if (user && db) {
          try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords', id.toString())); } catch(e) { console.error(e); }
        } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
      };

      const handleUpdateAlloc = (id, value) => {
        setAllocations(prev => prev.map(item => item.id === id ? { ...item, amount: value } : item));
      };

      const totalAllocated = allocations.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      const remaining = Number(bonusAmount || 0) - totalAllocated;

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-yellow-200 p-4 md:p-8 space-y-6">
          <div className="text-center mb-6">
             <h2 className="text-2xl md:text-3xl font-bold text-yellow-900 tracking-wider flex justify-center items-center gap-2">
               <Gift className="text-yellow-500" size={28}/> é¡å¤–æ”¶å…¥ / çé‡‘è¦åŠƒ
             </h2>
             <p className="text-yellow-700 text-sm mt-2">æ ¹æ“šæ‚¨ç›®å‰çš„è²¡å‹™éšæ®µï¼Œæä¾›æœ€ä½³åŒ–çš„è³‡é‡‘åˆ†é…ç­–ç•¥</p>
          </div>

          <div className="flex flex-wrap gap-4 bg-yellow-50 p-4 rounded-xl border border-yellow-200 shadow-sm">
            <div className="flex-1 min-w-[200px]">
              <label className="block text-sm font-bold text-yellow-900 mb-2 flex items-center gap-1"><Calendar size={18} /> çé‡‘è¦åŠƒåç¨±</label>
              <input type="text" value={recordName} onChange={(e) => setRecordName(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026ä¸­ç§‹çé‡‘ã€Q3ç¸¾æ•ˆçé‡‘" className="w-full p-2.5 border border-yellow-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 font-semibold text-gray-800" />
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div className="md:col-span-5 space-y-6">
              <div className="bg-yellow-50 p-5 rounded-xl border border-yellow-200">
                <label className="block text-sm font-bold text-yellow-800 mb-2">ğŸ’° ç¸½è¨ˆçé‡‘ / é¡å¤–æ”¶å…¥é‡‘é¡</label>
                <input type="number" value={bonusAmount} onChange={e => setBonusAmount(e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-3 text-xl font-bold text-yellow-900 border-2 border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:outline-none" placeholder="è«‹è¼¸å…¥ç¸½é¡" />
              </div>

              <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <label className="block text-sm font-bold text-gray-800 mb-3">ğŸ” é¸æ“‡æ‚¨ç¾éšæ®µçš„è²¡å‹™é‡å¿ƒï¼š</label>
                <div className="space-y-3">
                  <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'has_debt' ? 'border-red-400 bg-red-50' : 'border-gray-100 hover:border-gray-300'}`}>
                    <div className="flex items-center gap-2">
                      <input type="radio" name="status" checked={status === 'has_debt'} onChange={() => setStatus('has_debt')} className="text-red-500 focus:ring-red-500"/>
                      <span className="font-bold text-gray-800">å„ªå…ˆæ¸…å„Ÿå‚µå‹™</span>
                    </div>
                    <p className="text-xs text-gray-500 ml-6 mt-1">ä»æœ‰é«˜å¾ªç’°åˆ©æ¯çš„è² å‚µï¼ˆå¦‚å¡å‚µã€ä¿¡è²¸ç­‰ï¼‰</p>
                  </label>
                  <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'no_ef' ? 'border-blue-400 bg-blue-50' : 'border-gray-100 hover:border-gray-300'}`}>
                    <div className="flex items-center gap-2">
                      <input type="radio" name="status" checked={status === 'no_ef'} onChange={() => setStatus('no_ef')} className="text-blue-500 focus:ring-blue-500"/>
                      <span className="font-bold text-gray-800">å»ºæ§‹è²¡å‹™å®‰å…¨ç¶²</span>
                    </div>
                    <p className="text-xs text-gray-500 ml-6 mt-1">å°šæœªå­˜æ»¿ 6 å€‹æœˆä»¥ä¸Šçš„ç·Šæ€¥é å‚™é‡‘</p>
                  </label>
                  <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'has_ef' ? 'border-green-400 bg-green-50' : 'border-gray-100 hover:border-gray-300'}`}>
                    <div className="flex items-center gap-2">
                      <input type="radio" name="status" checked={status === 'has_ef'} onChange={() => setStatus('has_ef')} className="text-green-500 focus:ring-green-500"/>
                      <span className="font-bold text-gray-800">æ“´å¤§è³‡ç”¢èˆ‡æŠ•è³‡</span>
                    </div>
                    <p className="text-xs text-gray-500 ml-6 mt-1">å·²æœ‰å……è¶³å‚™ç”¨é‡‘ï¼Œå¯è‘—çœ¼é•·æœŸè³‡ç”¢å¢å€¼</p>
                  </label>
                </div>
              </div>
            </div>

            <div className="md:col-span-7">
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col">
                <div className="bg-gray-100 px-4 py-3 font-bold text-gray-800 text-center border-b border-gray-200 flex justify-between items-center">
                  <span>å»ºè­°åˆ†é…é †åº</span>
                  <span className={`text-sm px-2 py-1 rounded-full ${status === 'has_debt' ? 'bg-red-100 text-red-700' : status === 'no_ef' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                    {status === 'has_debt' ? 'ç†å‚µå„ªå…ˆæœŸ' : status === 'no_ef' ? 'é˜²è­·ç¶²å»ºæ§‹æœŸ' : 'è³‡ç”¢å¢å€¼æœŸ'}
                  </span>
                </div>
                <div className="flex bg-gray-50 border-b border-gray-200 text-sm font-semibold text-gray-500">
                  <div className="w-16 p-3 text-center border-r border-gray-200">é †åº</div>
                  <div className="flex-1 p-3 border-r border-gray-200">è¦åŠƒé …ç›® / èªªæ˜</div>
                  <div className="w-32 p-3 text-center">é…ç½®é‡‘é¡</div>
                </div>
                <div className="flex-1">
                  {allocations.map((item, index) => (
                    <div key={item.id} className="flex border-b border-gray-100 last:border-0 hover:bg-yellow-50/30 transition-colors">
                      <div className="w-16 p-3 flex items-center justify-center border-r border-gray-100 font-bold text-gray-400 text-lg">{index + 1}</div>
                      <div className="flex-1 p-3 border-r border-gray-100 flex flex-col justify-center">
                        <span className="font-bold text-gray-800">{item.name}</span>
                        <span className="text-xs text-gray-500">{item.desc}</span>
                      </div>
                      <div className="w-32 p-2 flex items-center justify-center">
                        <input type="number" value={item.amount} onChange={e => handleUpdateAlloc(item.id, e.target.value)} placeholder="è¨­å®šé‡‘é¡" className="w-full p-2 text-center border-b-2 border-gray-200 focus:border-yellow-500 focus:outline-none bg-transparent font-bold text-gray-700" />
                      </div>
                    </div>
                  ))}
                </div>
                <div className="bg-gray-50 p-4 border-t border-gray-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-gray-600 font-bold">å·²åˆ†é…ç¸½é¡</span>
                    <span className="font-bold text-gray-800">${totalAllocated.toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between items-center text-lg">
                    <span className="font-bold text-gray-800">å‰©é¤˜æœªåˆ†é…é¡åº¦</span>
                    <span className={`font-black ${remaining === 0 ? 'text-green-600' : remaining < 0 ? 'text-red-500' : 'text-yellow-600'}`}>${remaining.toLocaleString()}</span>
                  </div>
                  {remaining < 0 && <p className="text-xs text-red-500 text-right mt-1">âš ï¸ è­¦å‘Šï¼šé…ç½®ç¸½é¡å·²è¶…éçé‡‘ç¸½æ•¸ï¼</p>}
                  {remaining === 0 && Number(bonusAmount) > 0 && <p className="text-xs text-green-600 text-right mt-1 flex items-center justify-end gap-1"><CheckCircle2 size={14}/> è³‡é‡‘é…ç½®å®Œæˆï¼</p>}
                  
                  <button onClick={() => onImport(Number(bonusAmount || 0), allocations)} className="w-full mt-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-sm flex justify-center items-center gap-2 transition-colors">
                    åŒ¯å…¥æœ¬æœˆé ç®—è¡¨ <ArrowRight size={18} />
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button onClick={saveRecord} className="w-full py-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
            <Save size={24} /> å„²å­˜ã€Œ{recordName}ã€è¦åŠƒç´€éŒ„
          </button>

          {savedRecords.length > 0 && (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-yellow-200 mt-8">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-yellow-600"/>æ­·å²çé‡‘è¦åŠƒç´€éŒ„</h2>
              <div className="space-y-3">
                {savedRecords.map(record => (
                  <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-yellow-300 transition-colors">
                    <div>
                      <span className="font-bold text-yellow-800 text-lg">{record.recordName}</span>
                      <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()}</div>
                      <div className="text-sm font-bold text-yellow-600 mt-1">ç¸½é¡: ${(record.bonusAmount || 0).toLocaleString()}</div>
                    </div>
                    <div className="flex items-center gap-3 w-full md:w-auto">
                      <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-yellow-300 text-yellow-700 text-sm font-bold rounded-lg hover:bg-yellow-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                      <button onClick={() => deleteRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20} /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // === é ç®—å¥æª¢æˆæ•ˆå…ƒä»¶ ===
    const HealthCheckView = ({ db, user, appId, savedMonthlyRecords }) => {
      const [isLoaded, setIsLoaded] = useState(false);
      
      const [period, setPeriod] = useState(() => {
        const today = new Date();
        const quarter = Math.floor((today.getMonth() + 3) / 3);
        return `${today.getFullYear()}-Q${quarter} è²¡å‹™å¥æª¢`;
      });

      const [assets, setAssets] = useState([
        { id: 1, name: 'å„å®¶éŠ€è¡Œå­˜æ¬¾', pre: '', post: '' },
        { id: 2, name: 'æŠ•è³‡(è‚¡ç¥¨/ETF)', pre: '', post: '' },
        { id: 3, name: 'é›»æ”¯å¸³æˆ¶/å„²å€¼å¡', pre: '', post: '' },
        { id: 4, name: 'æŠ¼é‡‘/æ‡‰æ”¶æ¬¾', pre: '', post: '' },
      ]);
      const [liabilities, setLiabilities] = useState([
        { id: 1, name: 'ä¿¡ç”¨å¡æœªç¹³æ¬¾', pre: '', post: '' },
        { id: 2, name: 'å„é …è²¸æ¬¾', pre: '', post: '' },
        { id: 3, name: 'æ‡‰ä»˜/ä»£å¢Šæ¬¾', pre: '', post: '' },
      ]);

      const [premiumGoals, setPremiumGoals] = useState([{ id: 1, amount: '', date: '', done: false }]);
      const [fixedExpenses, setFixedExpenses] = useState([{ id: 1, name: '', amount: '' }]);
      const [budgets, setBudgets] = useState([{ id: 1, name: '', amount: '' }]);
      const [monthlyStats, setMonthlyStats] = useState([{ id: 1, name: '', amount: '' }]);
      
      const [savedHealthRecords, setSavedHealthRecords] = useState([]);

      const [importStartMonth, setImportStartMonth] = useState('');
      const [importEndMonth, setImportEndMonth] = useState('');

      useEffect(() => {
        if (!user || !db) { setIsLoaded(true); return; }
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'health');
        getDoc(docRef).then(snap => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.period) setPeriod(data.period);
            if (data.assets) setAssets(JSON.parse(data.assets));
            if (data.liabilities) setLiabilities(JSON.parse(data.liabilities));
            if (data.premiumGoals) setPremiumGoals(JSON.parse(data.premiumGoals));
            if (data.fixedExpenses) setFixedExpenses(JSON.parse(data.fixedExpenses));
            if (data.budgets) setBudgets(JSON.parse(data.budgets));
            if (data.monthlyStats) setMonthlyStats(JSON.parse(data.monthlyStats));
          }
          setIsLoaded(true);
        }).catch(() => setIsLoaded(true));

        const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'healthRecords');
        const unsubscribe = onSnapshot(recordsRef, (snap) => {
          const records = [];
          snap.forEach(d => records.push({ id: d.id, ...d.data() }));
          records.sort((a, b) => b.timestamp - a.timestamp); 
          setSavedHealthRecords(records);
        }, (err) => console.error("Health records snapshot error:", err));

        return () => unsubscribe();
      }, [user, db, appId]);

      useEffect(() => {
        if (!isLoaded || !user || !db) return;
        const timer = setTimeout(() => {
          const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'health');
          setDoc(docRef, { period, assets: JSON.stringify(assets), liabilities: JSON.stringify(liabilities), premiumGoals: JSON.stringify(premiumGoals), fixedExpenses: JSON.stringify(fixedExpenses), budgets: JSON.stringify(budgets), monthlyStats: JSON.stringify(monthlyStats) });
        }, 1500);
        return () => clearTimeout(timer);
      }, [period, assets, liabilities, premiumGoals, fixedExpenses, budgets, monthlyStats, isLoaded, user, db, appId]);

      const handleUpdateArr = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
      const handleAddArr = (setter, defaultObj) => setter(prev => [...prev, { id: Date.now(), ...defaultObj }]);
      const handleDelArr = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

      const handleAutoImport = () => {
        if (!importStartMonth || !importEndMonth) return alert('è«‹å…ˆé¸æ“‡èµ·å§‹èˆ‡çµæŸæœˆä»½ï¼');
        const filteredRecords = savedMonthlyRecords.filter(r => r.month >= importStartMonth && r.month <= importEndMonth);
        if (filteredRecords.length === 0) return alert(`åœ¨ ${importStartMonth} åˆ° ${importEndMonth} å€é–“å…§ï¼Œæ‰¾ä¸åˆ°ä»»ä½•å„²å­˜éçš„ã€Œçµç®—ç´€éŒ„ã€ï¼\nè«‹ç¢ºèªæ‚¨åœ¨ã€Œé ç®—åˆ†é…ã€åˆ†é ä¸­æ˜¯å¦æœ‰å„²å­˜éé€™å¹¾å€‹æœˆçš„è³‡æ–™ã€‚`);

        let sumIncome = 0, sumFixed = 0, sumDebt = 0, sumSavings = 0, sumLiving = 0;
        const newMonthlyStats = [];
        const sortedFiltered = [...filteredRecords].sort((a, b) => a.month.localeCompare(b.month));

        sortedFiltered.forEach((r, idx) => {
          sumIncome += Number(r.totalIncome || 0); sumFixed += Number(r.totalFixed || 0); sumDebt += Number(r.totalDebt || 0); sumSavings += Number(r.savingsAmount || 0); sumLiving += Number(r.totalLiving || 0);
          newMonthlyStats.push({ id: Date.now() + idx, name: r.month, amount: r.totalBalanceInv || 0 });
        });

        if (window.confirm(`æ‰¾åˆ° ${filteredRecords.length} ç­†çµç®—ç´€éŒ„ã€‚\nå³å°‡è‡ªå‹•è¦†è“‹å³ä¸‹æ–¹ã€Œå¯¦éš›é ç®—åˆ†é…é‡‘é¡ã€èˆ‡ã€Œæ¯æœˆå¯¦éš›çµé¤˜çµ±è¨ˆã€å…©å€‹è¡¨æ ¼ï¼Œç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ`)) {
          setBudgets([{ id: Date.now() + 1, name: 'å€é–“ç¸½æ”¶å…¥', amount: sumIncome }, { id: Date.now() + 2, name: 'å€é–“ç¸½å„²è“„', amount: sumSavings }, { id: Date.now() + 3, name: 'ç¸½å‚µå‹™æ”¤é‚„', amount: sumDebt }, { id: Date.now() + 4, name: 'ç¸½å›ºå®šæ”¯å‡º', amount: sumFixed }, { id: Date.now() + 5, name: 'ç¸½ç”Ÿæ´»èŠ±è²»', amount: sumLiving }]);
          setMonthlyStats(newMonthlyStats.length > 0 ? newMonthlyStats : [{ id: 1, name: '', amount: '' }]);
          alert('âœ… è‡ªå‹•åŠ ç¸½èˆ‡åŒ¯å…¥å®Œæˆï¼');
        }
      };

      const saveHealthRecord = async () => {
        if (!period.trim()) return alert("è«‹è¼¸å…¥è©•ä¼°æœŸæ•¸åç¨±");
        if (savedHealthRecords.some(r => r.period === period)) {
          if (!window.confirm(`${period} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
        }
        const recordData = { period, assets: JSON.stringify(assets), liabilities: JSON.stringify(liabilities), premiumGoals: JSON.stringify(premiumGoals), fixedExpenses: JSON.stringify(fixedExpenses), budgets: JSON.stringify(budgets), monthlyStats: JSON.stringify(monthlyStats), timestamp: Date.now() };
        if (user && db) {
          const existing = savedHealthRecords.find(r => r.period === period);
          const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'healthRecords');
          try {
            if (existing && existing.id) await setDoc(doc(colRef, existing.id), recordData);
            else await setDoc(doc(colRef, `${period}-${Date.now()}`), recordData);
          } catch (e) { console.error("Save health record error:", e); }
        } else {
           setSavedHealthRecords(prev => [...prev.filter(r => r.period !== period), { id: Date.now(), ...recordData }].sort((a, b) => b.timestamp - a.timestamp));
        }
      };

      const loadRecord = (record) => {
        if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.period}ã€çš„ç´€éŒ„å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
        setPeriod(record.period);
        if (record.assets) setAssets(JSON.parse(record.assets));
        if (record.liabilities) setLiabilities(JSON.parse(record.liabilities));
        setPremiumGoals(JSON.parse(record.premiumGoals)); setFixedExpenses(JSON.parse(record.fixedExpenses)); setBudgets(JSON.parse(record.budgets)); setMonthlyStats(JSON.parse(record.monthlyStats));
      };

      const deleteHealthRecord = async (id) => {
        if (user && db) {
          try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'healthRecords', id.toString())); } catch(e) { console.error(e); }
        } else { setSavedHealthRecords(prev => prev.filter(r => r.id !== id)); }
      };

      const totalPreAssets = useMemo(() => assets.reduce((sum, item) => sum + (Number(item.pre) || 0), 0), [assets]);
      const totalPostAssets = useMemo(() => assets.reduce((sum, item) => sum + (Number(item.post) || 0), 0), [assets]);
      const totalPreLiabilities = useMemo(() => liabilities.reduce((sum, item) => sum + (Number(item.pre) || 0), 0), [liabilities]);
      const totalPostLiabilities = useMemo(() => liabilities.reduce((sum, item) => sum + (Number(item.post) || 0), 0), [liabilities]);
      
      const preNetWorth = totalPreAssets - totalPreLiabilities;
      const postNetWorth = totalPostAssets - totalPostLiabilities;
      const netWorthGrowth = postNetWorth - preNetWorth;

      const totalFixed = useMemo(() => fixedExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [fixedExpenses]);
      const totalBudgets = useMemo(() => budgets.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [budgets]);
      const totalMonthly = useMemo(() => monthlyStats.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [monthlyStats]);

      const BalanceSheetTable = ({ title, items, setter, totalPre, totalPost, defaultNewObj, colorClass }) => {
        const totalDiff = totalPost - totalPre;
        
        return (
          <div className={`border rounded-lg overflow-hidden flex flex-col bg-white shadow-sm hover:shadow-md transition-shadow ${colorClass}`}>
            <div className={`px-4 py-2 font-bold text-center border-b text-sm md:text-base ${colorClass.replace('border-', 'bg-').replace('-200', '-100').replace('-300', '-100')} text-gray-800`}>{title}</div>
            <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
               <div className="w-[34%] p-2 text-center border-r border-gray-200">é …ç›® (å¦‚: è‚¡ç¥¨ä»£è™Ÿ)</div>
               <div className="w-[22%] p-2 text-center border-r border-gray-200">æœŸåˆé‡‘é¡</div>
               <div className="w-[22%] p-2 text-center border-r border-gray-200">æœŸæœ«ç¾å€¼</div>
               <div className="w-[22%] p-2 text-center">å¢æ¸› / æç›Š</div>
            </div>
            <div className="flex-1 p-1 space-y-1">
               {items.map((item) => {
                 const preVal = Number(item.pre) || 0;
                 const postVal = Number(item.post) || 0;
                 const diff = postVal - preVal;
                 
                 return (
                   <div key={item.id} className="flex items-center gap-1 group relative">
                     <input type="text" value={item.name} onChange={e => handleUpdateArr(setter, item.id, 'name', e.target.value)} className="w-[34%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent" placeholder="é …ç›®"/>
                     <input type="number" value={item.pre} onChange={e => handleUpdateArr(setter, item.id, 'pre', e.target.value)} className="w-[22%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="æœŸåˆ"/>
                     <input type="number" value={item.post} onChange={e => handleUpdateArr(setter, item.id, 'post', e.target.value)} className="w-[22%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="æœŸæœ«"/>
                     <div className={`w-[22%] p-1.5 text-xs md:text-sm text-center font-bold ${diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-500' : 'text-gray-400'}`}>
                       {diff > 0 ? '+' : ''}{diff === 0 && (item.pre === '' && item.post === '') ? '-' : diff.toLocaleString()}
                     </div>
                     <button onClick={() => handleDelArr(setter, item.id)} className="absolute -left-5 md:-left-6 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity"><Trash2 size={14}/></button>
                   </div>
                 );
               })}
               <button onClick={() => handleAddArr(setter, defaultNewObj)} className="w-full py-1.5 text-xs text-gray-400 hover:text-gray-600 bg-gray-50 rounded transition-colors flex items-center justify-center gap-1 mt-1"><Plus size={14} /> æ–°å¢é …ç›®</button>
            </div>
            <div className="flex bg-gray-100 font-bold text-sm border-t border-gray-200">
               <div className="w-[34%] p-2 text-center text-gray-600 border-r border-gray-200">åˆè¨ˆ</div>
               <div className="w-[22%] p-2 text-center text-gray-800 border-r border-gray-200">${totalPre.toLocaleString()}</div>
               <div className="w-[22%] p-2 text-center text-gray-800 border-r border-gray-200">${totalPost.toLocaleString()}</div>
               <div className={`w-[22%] p-2 text-center ${totalDiff > 0 ? 'text-green-600' : totalDiff < 0 ? 'text-red-600' : 'text-gray-600'}`}>
                 {totalDiff > 0 ? '+' : ''}{totalDiff.toLocaleString()}
               </div>
            </div>
          </div>
        );
      };

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-purple-100 p-4 md:p-8 space-y-6 md:space-y-8">
          <div className="text-center mb-6">
             <h2 className="text-2xl md:text-3xl font-bold text-purple-900 tracking-wider">è²¡å‹™å¥åº·æŒ‡æ¨™è¿½è¹¤</h2>
             <p className="text-purple-600 text-sm mt-2">éšæ®µæ€§å›é¡§ï¼šæª¢è¦–è³‡ç”¢è² å‚µè®ŠåŒ–èˆ‡è²¡å‹™ç›®æ¨™é”æˆç‡</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-purple-50 p-4 rounded-xl border border-purple-200 shadow-sm flex flex-col justify-between">
              <label className="block text-sm font-bold text-purple-900 mb-2 flex items-center gap-1"><Calendar size={18} /> 1. è¨­å®šè©•ä¼°æœŸæ•¸åç¨±</label>
              <input type="text" value={period} onChange={(e) => setPeriod(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026å¹´ç¬¬ä¸€å­£ã€2026ä¸‹åŠå¹´" className="w-full p-2.5 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 font-semibold text-gray-800" />
              <p className="text-xs text-gray-500 mt-2">ï¼ŠæœŸåˆï¼šè©²å€é–“é–‹å§‹å‰æ‚¨çš„è³‡ç”¢ç‹€æ³ã€‚<br/>ï¼ŠæœŸæœ«ï¼šè©²å€é–“çµæŸå¾Œæ‚¨çš„æœ€æ–°ç‹€æ³ã€‚</p>
            </div>

            <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-sm flex flex-col justify-between">
              <label className="block text-sm font-bold text-blue-900 mb-2 flex items-center gap-1"><Calculator size={18} /> 2. è‡ªå‹•çµç®—å€é–“è³‡æ–™ (é¸ç”¨)</label>
              <div className="flex items-center gap-2 mb-2">
                <input type="month" value={importStartMonth} onChange={e => setImportStartMonth(e.target.value)} className="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-300" />
                <span className="text-gray-500 font-bold">è‡³</span>
                <input type="month" value={importEndMonth} onChange={e => setImportEndMonth(e.target.value)} className="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-300" />
              </div>
              <button onClick={handleAutoImport} className="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg transition-colors flex items-center justify-center gap-1 shadow-sm"><Download size={16} /> è‡ªå‹•å½™æ•´æ­·å²ç´€éŒ„</button>
            </div>
          </div>
          
          <div className="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200 shadow-inner space-y-6">
            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2 border-b border-slate-300 pb-2"><PiggyBank className="text-slate-600" /> 3. å€‹äººè³‡ç”¢è² å‚µç›¤é» (å¯è¿½è¹¤æŠ•è³‡ç¸¾æ•ˆ)</h3>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
              <BalanceSheetTable title="ğŸ’° ç¸½è³‡ç”¢æ¸…å–® (å¸³æˆ¶é¤˜é¡ã€å„æª”è‚¡ç¥¨æŠ•è³‡)" items={assets} setter={setAssets} totalPre={totalPreAssets} totalPost={totalPostAssets} defaultNewObj={{ name: '', pre: '', post: '' }} colorClass="border-green-300" />
              <BalanceSheetTable title="ğŸ’³ ç¸½è² å‚µæ¸…å–® (è²¸æ¬¾ã€å¡è²»ã€æ‡‰ä»˜æ¬¾)" items={liabilities} setter={setLiabilities} totalPre={totalPreLiabilities} totalPost={totalPostLiabilities} defaultNewObj={{ name: '', pre: '', post: '' }} colorClass="border-red-300" />
            </div>
            <div className="bg-white rounded-xl shadow border border-purple-200 p-4 flex flex-col md:flex-row items-center justify-between gap-4">
              <div className="text-center w-full md:w-1/3"><div className="text-sm font-bold text-gray-500 mb-1">æœŸåˆ æ·¨è³‡ç”¢ç¸½è¨ˆ</div><div className="text-xl font-bold text-gray-800">${preNetWorth.toLocaleString()}</div></div>
              <div className="hidden md:block text-2xl text-gray-300">â¡ï¸</div>
              <div className="text-center w-full md:w-1/3"><div className="text-sm font-bold text-purple-600 mb-1">æœŸæœ« æ·¨è³‡ç”¢ç¸½è¨ˆ</div><div className="text-2xl font-black text-purple-900">${postNetWorth.toLocaleString()}</div></div>
              <div className="w-full md:w-1/3 border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-4 text-center"><div className="text-xs font-bold text-gray-500 mb-1">æœ¬æœŸæ·¨è³‡ç”¢æˆé•·</div><div className={`text-lg font-bold flex items-center justify-center gap-1 ${netWorthGrowth >= 0 ? 'text-green-600' : 'text-red-500'}`}>{netWorthGrowth >= 0 ? <TrendingUp size={18}/> : <TrendingUp size={18} className="rotate-180"/>}${Math.abs(netWorthGrowth).toLocaleString()}</div></div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
             <ArrayTable title="å¹´åº¦å¤§ç­†æ”¯å‡º/é å­˜ç›®æ¨™" columns={[{ width: 'w-2/5', label: 'ç›®æ¨™é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }, { width: 'w-2/5', label: 'é è¨ˆé”æˆæ™‚', field: 'date', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.date} onChange={e=>onChange(e.target.value)} placeholder="å¦‚: 10æœˆ"/> }, { width: 'w-1/5', label: 'å®Œæˆ', field: 'done', render: (item, onChange) => <button onClick={()=>onChange(!item.done)} className="text-purple-600 hover:text-purple-800 transition-colors">{item.done ? <CheckSquare size={18}/> : <Square size={18} className="text-gray-300"/>}</button> }]} items={premiumGoals} setter={setPremiumGoals} defaultNewObj={{ amount: '', date: '', done: false }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
             <ArrayTable title="å›ºå®šæ”¯å‡ºæª¢è¦–" columns={[{ width: 'w-1/2', label: 'æ”¯å‡ºé …ç›®', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="é …ç›®åç¨±"/> }, { width: 'w-1/2', label: 'é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={fixedExpenses} setter={setFixedExpenses} totalLabel="åˆè¨ˆ" totalValue={totalFixed} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
             <ArrayTable title="å¯¦éš›é ç®—åˆ†é…é‡‘é¡ (å¯è‡ªå‹•åŒ¯å…¥)" columns={[{ width: 'w-1/2', label: 'é ç®—é …ç›®', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="é …ç›®åç¨±"/> }, { width: 'w-1/2', label: 'é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={budgets} setter={setBudgets} totalLabel="åˆè¨ˆ" totalValue={totalBudgets} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
             <ArrayTable title="æ¯æœˆå¯¦éš›çµé¤˜çµ±è¨ˆ (å¯è‡ªå‹•åŒ¯å…¥)" columns={[{ width: 'w-1/2', label: 'æœˆä»½', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="å¦‚: 10æœˆ"/> }, { width: 'w-1/2', label: 'çµé¤˜é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={monthlyStats} setter={setMonthlyStats} totalLabel="åˆè¨ˆ" totalValue={totalMonthly} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
          </div>

          <button onClick={saveHealthRecord} className="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
            <Save size={24} /> å„²å­˜ã€Œ{period}ã€å¥æª¢ç´€éŒ„
          </button>

          {savedHealthRecords.length > 0 && (
            <div className="bg-white p-5 rounded-xl shadow-sm border border-purple-200 mt-8">
              <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-purple-600"/>æ­·å²å¥æª¢ç´€éŒ„</h2>
              <div className="space-y-3">
                {savedHealthRecords.map(record => (
                  <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-purple-300 transition-colors">
                    <div>
                      <span className="font-bold text-purple-800 text-lg">{record.period}</span>
                      <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()} {new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div className="flex items-center gap-3 w-full md:w-auto">
                      <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-purple-300 text-purple-700 text-sm font-bold rounded-lg hover:bg-purple-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                      <button onClick={() => deleteHealthRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="åˆªé™¤ç´€éŒ„"><Trash2 size={20} /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // === ä¸»ç¨‹å¼ ===
    function App() {
      const [currentView, setCurrentView] = useState('accounts'); // é è¨­é€²å…¥å¸³æˆ¶ç®¡ç†
      const [user, setUser] = useState(null);
      const [isLoaded, setIsLoaded] = useState(false);
      
      useEffect(() => {
        if (!auth) { setIsLoaded(true); return; }
        const initAuth = async () => {
          try {
            await signInAnonymously(auth);
          } catch (err) { console.error("Auth error:", err); }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
      }, []);

      const [month, setMonth] = useState(() => { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; });
      
      // æ ¸å¿ƒç‹€æ…‹ï¼šç³»çµ±ç¸½å¸³æˆ¶æ¸…å–®
      const [accounts, setAccounts] = useState([
        { id: 1, name: 'ä¸»é–‹éŠ·éŠ€è¡Œ', balance: 0 },
        { id: 2, name: 'æ•¸ä½æ”¯ä»˜(LinePay)', balance: 0 },
        { id: 3, name: 'ä¿¡ç”¨å¡(å¡«è² æ•¸)', balance: 0 },
      ]);

      const [incomes, setIncomes] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [masterDebts, setMasterDebts] = useState([{ id: 1, name: '', amount: '', note: '', dueDate: '', account: '' }]);
      const [savingsRate, setSavingsRate] = useState(30);
      const [debts, setDebts] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [fixedExpenses, setFixedExpenses] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [investments, setInvestments] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [livingExpenses, setLivingExpenses] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [balanceInventory, setBalanceInventory] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [balanceAllocation, setBalanceAllocation] = useState([{ id: 1, name: '', amount: '', account: '' }]);
      const [savedRecords, setSavedRecords] = useState([]);

      useEffect(() => {
        if (!user || !db) { setIsLoaded(true); return; }
        
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'budget');
        getDoc(docRef).then(snap => {
          if (snap.exists()) {
            const data = snap.data();
            if(data.accounts) setAccounts(JSON.parse(data.accounts));
            if(data.incomes) setIncomes(JSON.parse(data.incomes));
            if(data.masterDebts) setMasterDebts(JSON.parse(data.masterDebts));
            if(data.debts) setDebts(JSON.parse(data.debts));
            if(data.fixedExpenses) setFixedExpenses(JSON.parse(data.fixedExpenses));
            if(data.investments) setInvestments(JSON.parse(data.investments)); // è®€å–æŠ•è³‡è³‡æ–™
            if(data.livingExpenses) setLivingExpenses(JSON.parse(data.livingExpenses));
            if(data.savingsRate) setSavingsRate(data.savingsRate);
            if(data.balanceInventory) setBalanceInventory(JSON.parse(data.balanceInventory));
            if(data.balanceAllocation) setBalanceAllocation(JSON.parse(data.balanceAllocation));
          }
          setIsLoaded(true);
        }).catch(() => setIsLoaded(true));

        const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords');
        const unsubscribe = onSnapshot(recordsRef, (snap) => {
          const records = [];
          snap.forEach(d => records.push({ id: d.id, ...d.data() }));
          records.sort((a, b) => b.month.localeCompare(a.month));
          setSavedRecords(records);
        }, (err) => console.error("Records snapshot error:", err));
        return () => unsubscribe();
      }, [user, db]);

      useEffect(() => {
        if (!isLoaded || !user || !db) return;
        const timer = setTimeout(() => {
          const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'budget');
          setDoc(docRef, { accounts: JSON.stringify(accounts), incomes: JSON.stringify(incomes), masterDebts: JSON.stringify(masterDebts), debts: JSON.stringify(debts), fixedExpenses: JSON.stringify(fixedExpenses), investments: JSON.stringify(investments), livingExpenses: JSON.stringify(livingExpenses), savingsRate, balanceInventory: JSON.stringify(balanceInventory), balanceAllocation: JSON.stringify(balanceAllocation) });
        }, 1500);
        return () => clearTimeout(timer);
      }, [accounts, incomes, masterDebts, debts, fixedExpenses, investments, livingExpenses, savingsRate, balanceInventory, balanceAllocation, isLoaded, user, db]);

      const totalMasterDebt = useMemo(() => masterDebts.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [masterDebts]);
      const totalIncome = useMemo(() => incomes.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [incomes]);
      const totalDebt = useMemo(() => debts.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [debts]);
      const totalFixed = useMemo(() => fixedExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [fixedExpenses]);
      const totalInvestment = useMemo(() => investments.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [investments]);
      const totalLiving = useMemo(() => livingExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [livingExpenses]);
      const totalBalanceInv = useMemo(() => balanceInventory.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [balanceInventory]);
      const totalBalanceAlloc = useMemo(() => balanceAllocation.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [balanceAllocation]);

      // æ ¸å¿ƒé‚è¼¯æ›´æ–°ï¼šæ‰£é™¤æŠ•è³‡é‡‘é¡
      const availableBudget = totalIncome - totalDebt - totalFixed - totalInvestment;
      const savingsAmount = Math.round(availableBudget * (savingsRate / 100));
      const livingBudget = availableBudget - savingsAmount;
      const remainingLiving = livingBudget - totalLiving;
      const remainingBalanceAlloc = totalBalanceInv - totalBalanceAlloc;

      // å„å¸³æˆ¶è³‡é‡‘æµå‘èˆ‡å³æ™‚é ä¼°é¤˜é¡çµç®—
      const accountFlows = useMemo(() => {
        const flows = {};
        accounts.forEach(acc => {
          flows[acc.name] = { in: 0, out: 0, initial: Number(acc.balance) || 0 };
        });

        const addFlow = (item, type) => {
          const acc = item.account?.trim();
          if (!acc || !flows[acc]) return; 
          if (type === 'in') flows[acc].in += (Number(item.amount) || 0);
          if (type === 'out') flows[acc].out += (Number(item.amount) || 0);
        };

        incomes.forEach(i => addFlow(i, 'in'));
        debts.forEach(i => addFlow(i, 'out'));
        fixedExpenses.forEach(i => addFlow(i, 'out'));
        investments.forEach(i => addFlow(i, 'out'));
        livingExpenses.forEach(i => addFlow(i, 'out'));
        balanceAllocation.forEach(i => addFlow(i, 'out'));

        return Object.entries(flows).map(([name, data]) => ({
          name,
          initial: data.initial,
          in: data.in,
          out: data.out,
          net: data.in - data.out,
          projected: data.initial + data.in - data.out
        })).sort((a, b) => b.projected - a.projected); 
      }, [accounts, incomes, debts, fixedExpenses, investments, livingExpenses, balanceAllocation]);

      const handleAddItem = (setter, initialFields = { name: '', amount: 0, account: '' }) => setter(prev => [...prev, { id: Date.now(), ...initialFields }]);
      const handleUpdateItem = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
      const handleDeleteItem = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

      const handleImportBonus = (bonusAmt, allocs) => {
        if (!window.confirm(`ç¢ºå®šè¦å°‡é¡å¤–æ”¶å…¥ $${bonusAmt.toLocaleString()} åŠåˆ†é…é …ç›®åŒ¯å…¥ã€Œæ¯æœˆé ç®—è¡¨ã€ä¸­å—ï¼Ÿ`)) return;
        setIncomes(prev => [...prev.filter(item => item.name || item.amount), { id: Date.now(), name: 'çé‡‘/é¡å¤–æ”¶å…¥', amount: bonusAmt, account: '' }]);
        const newDebts = []; const newFixed = [];
        allocs.forEach((alloc, idx) => {
          if (!alloc.amount || Number(alloc.amount) <= 0) return;
          const amt = Number(alloc.amount); const id = Date.now() + 10 + idx;
          if (alloc.name.includes('å‚µå‹™') || alloc.name.includes('è² å‚µ')) newDebts.push({ id, name: `[çé‡‘] ${alloc.name}`, amount: amt, account: '' });
          else newFixed.push({ id, name: `[çé‡‘] ${alloc.name}`, amount: amt, account: '' });
        });
        if (newDebts.length > 0) setDebts(prev => [...prev.filter(item => item.name || item.amount), ...newDebts]);
        if (newFixed.length > 0) setFixedExpenses(prev => [...prev.filter(item => item.name || item.amount), ...newFixed]);
        setCurrentView('budget');
      };

      const saveCurrentMonth = async () => {
        if (savedRecords.some(r => r.month === month)) if (!window.confirm(`${month} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
        const newRecord = { month, totalIncome, totalDebt, totalFixed, totalInvestment, availableBudget, savingsRate, savingsAmount, livingBudget, totalLiving, totalBalanceInv, totalBalanceAlloc, timestamp: Date.now(), incomes: JSON.stringify(incomes), masterDebts: JSON.stringify(masterDebts), debts: JSON.stringify(debts), fixedExpenses: JSON.stringify(fixedExpenses), investments: JSON.stringify(investments), livingExpenses: JSON.stringify(livingExpenses), balanceInventory: JSON.stringify(balanceInventory), balanceAllocation: JSON.stringify(balanceAllocation) };
        if (user && db) {
          const existing = savedRecords.find(r => r.month === month);
          const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords');
          try {
            if (existing && existing.id) await setDoc(doc(colRef, existing.id), newRecord);
            else await setDoc(doc(colRef, `${month}-${Date.now()}`), newRecord);
          } catch (e) { console.error("Save record error:", e); }
        } else {
          setSavedRecords(prev => [...prev.filter(r => r.month !== month), { id: Date.now(), ...newRecord }].sort((a, b) => b.month.localeCompare(a.month)));
        }
      };

      const loadBudgetRecord = (record) => {
        if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ ${record.month} çš„ç´€éŒ„å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
        setMonth(record.month);
        if(record.savingsRate) setSavingsRate(record.savingsRate);
        if(record.incomes) setIncomes(JSON.parse(record.incomes));
        if(record.masterDebts) setMasterDebts(JSON.parse(record.masterDebts));
        if(record.debts) setDebts(JSON.parse(record.debts));
        if(record.fixedExpenses) setFixedExpenses(JSON.parse(record.fixedExpenses));
        if(record.investments) setInvestments(JSON.parse(record.investments)); // è¼‰å…¥æŠ•è³‡è³‡æ–™
        if(record.livingExpenses) setLivingExpenses(JSON.parse(record.livingExpenses));
        if(record.balanceInventory) setBalanceInventory(JSON.parse(record.balanceInventory));
        if(record.balanceAllocation) setBalanceAllocation(JSON.parse(record.balanceAllocation));
      };

      const deleteRecord = async (id) => {
        if (user && db) {
          try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords', id.toString())); } catch(e) { console.error(e); }
        } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
      };

      return (
        <div className="min-h-screen bg-slate-50 text-gray-800 font-sans p-4 md:p-8">
          <div className="max-w-6xl mx-auto space-y-6 relative">
            
            {/* Header */}
            <div className="bg-purple-100 rounded-2xl p-6 shadow-sm border border-purple-200 text-center relative overflow-hidden flex flex-col items-center justify-center">
              {user && db && (
                 <div className="absolute top-4 right-4 text-green-600 flex items-center gap-1 text-xs font-bold bg-white/80 px-3 py-1.5 rounded-full shadow-sm">
                   <Cloud size={14} className="animate-pulse" /> é›²ç«¯åŒæ­¥ä¸­
                 </div>
              )}
              <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300"></div>
              <h1 className="text-2xl md:text-3xl font-bold text-purple-900 mb-2 mt-4 md:mt-2">æ™ºèƒ½è²¡å‹™ç®¡å®¶</h1>
              <p className="text-purple-700">å€‹äººæ”¶æ”¯èˆ‡å¤šå¸³æˆ¶è³‡é‡‘åˆ†é…ç³»çµ±</p>
            </div>

            {/* åˆ†é åˆ‡æ›å°è¦½åˆ— */}
            <div className="grid grid-cols-3 md:flex md:flex-wrap bg-white rounded-xl shadow-sm border border-gray-200 p-1 mb-6 gap-1 md:gap-0">
              <button onClick={() => setCurrentView('instructions')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'instructions' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><BookOpen size={18} className="hidden sm:block" />ç³»çµ±èªªæ˜</button>
              <button onClick={() => setCurrentView('accounts')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'accounts' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-blue-50'}`}><CreditCard size={18} className="hidden sm:block" />å¸³æˆ¶ç¸½è¡¨</button>
              <button onClick={() => setCurrentView('budget')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'budget' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><LayoutDashboard size={18} className="hidden sm:block" />é ç®—åˆ†é…</button>
              <button onClick={() => setCurrentView('emergency')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'emergency' ? 'bg-pink-600 text-white shadow' : 'text-gray-500 hover:bg-pink-50'}`}><ShieldAlert size={18} className="hidden sm:block" />é å‚™é‡‘è©¦ç®—</button>
              <button onClick={() => setCurrentView('bonus')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'bonus' ? 'bg-yellow-500 text-white shadow' : 'text-gray-500 hover:bg-yellow-50'}`}><Gift size={18} className="hidden sm:block" />çé‡‘è¦åŠƒ</button>
              <button onClick={() => setCurrentView('health')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'health' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><Activity size={18} className="hidden sm:block" />è²¡å‹™è¿½è¹¤</button>
            </div>

            {currentView === 'instructions' && <InstructionsView />}

            {currentView === 'accounts' && (
              <div className="space-y-6">
                <div className="bg-blue-50 rounded-2xl p-6 shadow-sm border border-blue-200 text-center">
                   <h2 className="text-2xl font-bold text-blue-900 mb-2 flex items-center justify-center gap-2"><CreditCard size={24} /> å¸³æˆ¶èˆ‡è³‡ç”¢ç¸½è¡¨</h2>
                   <p className="text-blue-700">ç®¡ç†æ‚¨çš„éŠ€è¡Œå¸³æˆ¶ã€é›»å­æ”¯ä»˜èˆ‡ä¿¡ç”¨å¡ï¼Œéš¨æ™‚æŒæ¡å³æ™‚é¤˜é¡</p>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6">
                   <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 border-b pb-4">
                     <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Wallet className="text-blue-600"/> æˆ‘çš„å¸³æˆ¶æ¸…å–®</h3>
                     <div className="text-sm bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-bold shadow-inner">
                       è¡¨å®šç¸½è³‡ç”¢: ${accounts.reduce((sum, a) => sum + (Number(a.balance) || 0), 0).toLocaleString()}
                     </div>
                   </div>
                   
                   <div className="space-y-3">
                     {accounts.map(acc => (
                       <div key={acc.id} className="flex flex-col md:flex-row gap-3 items-center p-3 border border-gray-100 rounded-lg hover:bg-blue-50/50 transition-colors">
                          <div className="w-full md:w-1/2">
                            <label className="block text-xs text-gray-500 mb-1 font-bold">å¸³æˆ¶åç¨± (æä¾›ä¸‹æ‹‰é¸å–®ä½¿ç”¨)</label>
                            <input type="text" value={acc.name} onChange={e => handleUpdateItem(setAccounts, acc.id, 'name', e.target.value)} className="w-full p-2.5 border rounded focus:ring-2 focus:ring-blue-300" placeholder="ä¾‹å¦‚: å°æ–°è–ªè½‰ã€LinePayã€ç‰å±±ä¿¡ç”¨å¡" />
                          </div>
                          <div className="w-full md:w-2/5">
                            <label className="block text-xs text-gray-500 mb-1 font-bold">ç›®å‰çœŸå¯¦é¤˜é¡ (ä¿¡ç”¨å¡æ¬ æ¬¾è«‹å¡«è² æ•¸)</label>
                            <input type="number" value={acc.balance === 0 ? 0 : (acc.balance || '')} onChange={e => handleUpdateItem(setAccounts, acc.id, 'balance', e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-2.5 border rounded focus:ring-2 focus:ring-blue-300 font-bold text-gray-700" placeholder="0" />
                          </div>
                          <div className="w-full md:w-auto flex justify-end md:self-end md:mb-1">
                            <button onClick={() => handleDeleteItem(setAccounts, acc.id)} className="p-2.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20}/></button>
                          </div>
                       </div>
                     ))}
                     <button onClick={() => handleAddItem(setAccounts, { name: '', balance: 0 })} className="w-full py-4 mt-2 border-2 border-dashed border-blue-200 text-blue-600 hover:bg-blue-50 rounded-xl font-bold flex justify-center items-center gap-2 transition-colors"><Plus size={20}/> æ–°å¢å¸³æˆ¶ / è³‡ç”¢</button>
                   </div>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                  <div className="px-4 py-3 border-b bg-gray-50">
                    <h3 className="font-bold text-gray-800 flex items-center gap-2"><TrendingUp size={18} className="text-green-600"/> çµåˆã€Œé ç®—è¡¨ã€ä¹‹é ä¼°å³æ™‚é¤˜é¡</h3>
                  </div>
                  <div className="p-2 overflow-x-auto">
                     <table className="w-full text-sm text-left min-w-[500px]">
                       <thead className="text-xs text-gray-500 bg-gray-100">
                         <tr>
                           <th className="px-4 py-3">å¸³æˆ¶åç¨±</th>
                           <th className="px-4 py-3 text-right">ç›®å‰è¨­å®šé¤˜é¡</th>
                           <th className="px-4 py-3 text-right">é ç®—è¡¨æµå…¥ (+)</th>
                           <th className="px-4 py-3 text-right">é ç®—è¡¨æµå‡º (-)</th>
                           <th className="px-4 py-3 text-right text-blue-700">é ç®—åŸ·è¡Œå¾Œé¤˜é¡</th>
                         </tr>
                       </thead>
                       <tbody>
                         {accountFlows.map(flow => (
                           <tr key={flow.name} className="border-b border-gray-50 last:border-0 hover:bg-blue-50/30">
                             <td className="px-4 py-3 font-bold text-gray-700">{flow.name || '(æœªå‘½å)'}</td>
                             <td className="px-4 py-3 text-right">${flow.initial.toLocaleString()}</td>
                             <td className="px-4 py-3 text-right text-green-600">{flow.in > 0 ? `+${flow.in.toLocaleString()}` : '-'}</td>
                             <td className="px-4 py-3 text-right text-red-500">{flow.out > 0 ? `-${flow.out.toLocaleString()}` : '-'}</td>
                             <td className={`px-4 py-3 text-right font-black text-lg ${flow.projected >= 0 ? 'text-blue-600' : 'text-red-600'}`}>${flow.projected.toLocaleString()}</td>
                           </tr>
                         ))}
                         {accountFlows.length === 0 && (
                           <tr><td colSpan="5" className="text-center py-6 text-gray-400">ç›®å‰é ç®—è¡¨ä¸­æ²’æœ‰ç´€éŒ„ä½¿ç”¨ä»»ä½•å¸³æˆ¶</td></tr>
                         )}
                       </tbody>
                     </table>
                  </div>
                </div>
              </div>
            )}

            {currentView === 'budget' && (
              <>
                <div className="flex flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                  <div className="flex-1 min-w-[200px]">
                    <label className="block text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1"><Calendar size={16} /> çµç®—æœˆä»½</label>
                    <input type="month" value={month} onChange={(e) => setMonth(e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <label className="block text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1"><DollarSign size={16} /> æœ¬æœˆç¸½æ”¶å…¥</label>
                    <div className="w-full p-2 border border-gray-100 bg-gray-50 rounded-lg text-lg font-bold text-purple-700">${totalIncome.toLocaleString()}</div>
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                  <div className="lg:col-span-7 space-y-6">
                    <ExpenseTable title="æœ¬æœˆæ”¶å…¥æ¸…å–®" items={incomes} setter={setIncomes} total={totalIncome} icon={DollarSign} colorClass="border-yellow-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                    
                    <MasterDebtTable masterDebts={masterDebts} setMasterDebts={setMasterDebts} setDebts={setDebts} setFixedExpenses={setFixedExpenses} handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} totalMasterDebt={totalMasterDebt} accounts={accounts} />
                    
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                      <ExpenseTable title="å„ªå…ˆå„Ÿé‚„è² å‚µ" items={debts} setter={setDebts} total={totalDebt} icon={TrendingUp} colorClass="border-red-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                      <ExpenseTable title="å›ºå®šæ”¯å‡º" items={fixedExpenses} setter={setFixedExpenses} total={totalFixed} icon={Wallet} colorClass="border-blue-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                    </div>
                    
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                      <ExpenseTable title="æŠ•è³‡èˆ‡ç†è²¡" items={investments} setter={setInvestments} total={totalInvestment} icon={PieChart} colorClass="border-indigo-300" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                      <ExpenseTable title="ç”Ÿæ´»è²»åˆ†é…" items={livingExpenses} setter={setLivingExpenses} total={totalLiving} icon={Wallet} colorClass="border-green-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                    </div>
                  
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 pt-6 border-t border-gray-200 mt-6">
                      <ExpenseTable title="æœˆåº•é¤˜é¡ç›¤é»" items={balanceInventory} setter={setBalanceInventory} total={totalBalanceInv} icon={Wallet} colorClass="border-indigo-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                      <ExpenseTable title="é¤˜é¡å†åˆ†é…" items={balanceAllocation} setter={setBalanceAllocation} total={totalBalanceAlloc} icon={TrendingUp} colorClass="border-teal-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                    </div>

                    {accountFlows.length > 0 && (
                      <div className="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden mt-6 hidden lg:block">
                        <div className="px-4 py-3 border-b bg-blue-50 flex items-center justify-between">
                          <h3 className="font-bold flex items-center gap-2 text-blue-900"><Wallet size={18} className="text-blue-600" /> ğŸ¦ å„å¸³æˆ¶è³‡é‡‘æµå‘èˆ‡å³æ™‚é¤˜é¡</h3>
                        </div>
                        <div className="p-2 overflow-x-auto">
                          <table className="w-full text-sm text-left min-w-[500px]">
                            <thead className="text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
                              <tr><th className="px-3 py-2 w-1/4">å¸³æˆ¶åç¨±</th><th className="px-3 py-2 text-right">ç›®å‰é¤˜é¡</th><th className="px-3 py-2 text-right">é è¨ˆæ·¨è®Šå‹•</th><th className="px-3 py-2 text-right text-blue-700 font-bold">é ä¼°å³æ™‚é¤˜é¡</th></tr>
                            </thead>
                            <tbody>
                              {accountFlows.map((flow, idx) => (
                                <tr key={idx} className="border-b border-gray-50 last:border-0 hover:bg-blue-50/30 transition-colors">
                                  <td className="px-3 py-2 font-bold text-gray-700">{flow.name || '(æœªé¸æ“‡)'}</td>
                                  <td className="px-3 py-2 text-right">${flow.initial.toLocaleString()}</td>
                                  <td className={`px-3 py-2 text-right font-bold ${flow.net > 0 ? 'text-green-600' : flow.net < 0 ? 'text-red-500' : 'text-gray-500'}`}>{flow.net > 0 ? '+' : ''}{flow.net.toLocaleString()}</td>
                                  <td className={`px-3 py-2 text-right font-black ${flow.projected >= 0 ? 'text-blue-600' : 'text-red-600'}`}>${flow.projected.toLocaleString()}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="lg:col-span-5 space-y-6">
                    <div className="bg-purple-50 p-5 rounded-xl shadow-sm border border-purple-200 sticky top-4">
                      <h2 className="text-xl font-bold text-purple-900 mb-4 border-b border-purple-200 pb-2">çµç®—è¨ˆç®—çœ‹æ¿</h2>
                      <div className="space-y-4 text-sm md:text-base">
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 1: è¨ˆç®—å¯ç”¨é¡åº¦</p>
                          <div className="flex justify-between items-center mb-1"><span>ç¸½æ”¶å…¥</span><span>${totalIncome.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center text-red-500 mb-1"><span>- è² å‚µ</span><span>${totalDebt.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center text-blue-500 mb-1"><span>- å›ºå®šæ”¯å‡º</span><span>${totalFixed.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center text-indigo-500 border-b pb-2 mb-2"><span>- æŠ•è³‡ç†è²¡</span><span>${totalInvestment.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center font-bold text-purple-700 text-lg"><span>= å¯ç”¨è³‡é‡‘</span><span>${availableBudget.toLocaleString()}</span></div>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-gray-500 mb-2 text-xs font-bold tracking-wider flex justify-between">
                            <span>STEP 2: å„²è“„ç›®æ¨™è¨­å®š</span>
                            <span className="flex items-center gap-1">åˆ†é…æ¯”ä¾‹: <input type="number" value={savingsRate} onChange={(e) => setSavingsRate(Number(e.target.value))} className="w-12 border rounded px-1 text-center"/> %</span>
                          </p>
                          <div className="flex justify-between items-center font-bold text-green-600 text-lg"><span>æ‡‰å­˜é‡‘é¡</span><span>${savingsAmount.toLocaleString()}</span></div>
                        </div>
                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 3: ç”Ÿæ´»è²»é¡åº¦æ ¸ç®—</p>
                          <div className="flex justify-between items-center text-purple-700 mb-1"><span>å¯ç”¨è³‡é‡‘</span><span>${availableBudget.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center text-green-600 border-b pb-2 mb-2"><span>- æ‡‰å­˜é‡‘é¡</span><span>${savingsAmount.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center font-bold text-gray-800 text-lg mb-2"><span>= å‰©é¤˜ç”Ÿæ´»è²»é¡åº¦</span><span>${livingBudget.toLocaleString()}</span></div>
                          <div className="mt-3 pt-3 border-t border-dashed border-gray-300">
                            <div className="flex justify-between items-center text-sm"><span>è¡¨æ ¼å·²åˆ†é…ä¹‹ç”Ÿæ´»è²»</span><span>${totalLiving.toLocaleString()}</span></div>
                            <div className={`flex justify-between items-center font-bold text-sm mt-1 ${remainingLiving < 0 ? 'text-red-500' : 'text-gray-500'}`}>
                              <span>æ ¸å°å·®é¡ (é€æ”¯/ç›ˆé¤˜)</span><span>${remainingLiving.toLocaleString()}</span>
                            </div>
                          </div>
                        </div>

                        <div className="bg-white p-3 rounded-lg shadow-sm">
                          <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 4: æœˆåº•çµé¤˜å†åˆ†é…</p>
                          <div className="flex justify-between items-center text-indigo-700 mb-1"><span>ç›¤é»ç¸½çµé¤˜</span><span>${totalBalanceInv.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center text-teal-600 border-b pb-2 mb-2"><span>- å·²è¨­å®šå†åˆ†é…</span><span>${totalBalanceAlloc.toLocaleString()}</span></div>
                          <div className="flex justify-between items-center font-bold text-gray-800 text-lg mb-2">
                            <span>= å°šæœªåˆ†é…çµé¤˜</span>
                            <span className={remainingBalanceAlloc < 0 ? 'text-red-500' : 'text-gray-800'}>${remainingBalanceAlloc.toLocaleString()}</span>
                          </div>
                        </div>

                        <button onClick={saveCurrentMonth} className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-4">
                          <Save size={20} />å„²å­˜ {month} çµç®—æ˜ç´°
                        </button>
                      </div>
                    </div>

                    {accountFlows.length > 0 && (
                      <div className="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden mt-6 block lg:hidden">
                        <div className="px-4 py-3 border-b bg-blue-50 flex items-center justify-between">
                          <h3 className="font-bold flex items-center gap-2 text-blue-900"><Wallet size={18} className="text-blue-600" /> å„å¸³æˆ¶å³æ™‚é¤˜é¡</h3>
                        </div>
                        <div className="p-2 overflow-x-auto">
                          <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
                              <tr><th className="px-3 py-2">å¸³æˆ¶åç¨±</th><th className="px-3 py-2 text-right">é è¨ˆè®Šå‹•</th><th className="px-3 py-2 text-right text-blue-700">é ä¼°é¤˜é¡</th></tr>
                            </thead>
                            <tbody>
                              {accountFlows.map((flow, idx) => (
                                <tr key={idx} className="border-b border-gray-50">
                                  <td className="px-3 py-2 font-bold text-gray-700">{flow.name || '(æœªé¸æ“‡)'}</td>
                                  <td className={`px-3 py-2 text-right font-bold ${flow.net > 0 ? 'text-green-600' : flow.net < 0 ? 'text-red-500' : 'text-gray-500'}`}>{flow.net > 0 ? '+' : ''}{flow.net.toLocaleString()}</td>
                                  <td className="px-3 py-2 text-right font-black">${flow.projected.toLocaleString()}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                    {savedRecords.length > 0 && (
                      <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                         <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-purple-600"/>æ­·å²çµç®—ç´€éŒ„</h2>
                        <div className="space-y-3">
                          {savedRecords.map(record => (
                            <div key={record.id} className="p-3 border rounded-lg bg-gray-50 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 group hover:border-purple-300 transition-colors">
                              <div className="w-full">
                                <div className="font-bold text-purple-700 text-lg mb-2">{record.month}</div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-x-2 gap-y-1 text-xs text-gray-600">
                                  <div>ç¸½æ”¶å…¥: ${record.totalIncome.toLocaleString()}</div>
                                  <div>ç¸½è² å‚µ: ${record.totalDebt.toLocaleString()}</div>
                                  <div>å›ºå®šæ”¯å‡º: ${record.totalFixed.toLocaleString()}</div>
                                  <div>æŠ•è³‡ç†è²¡: ${(record.totalInvestment || 0).toLocaleString()}</div>
                                  <div className="font-bold text-green-600">å„²è“„: ${record.savingsAmount.toLocaleString()}</div>
                                  <div className="text-gray-500">ç”Ÿæ´»è²»: ${record.totalLiving.toLocaleString()}</div>
                                  {record.totalBalanceInv > 0 && (
                                    <div className="col-span-2 md:col-span-3 mt-1 pt-1 border-t border-gray-100 flex justify-between font-bold text-indigo-600">
                                      <span>æœˆåº•çµé¤˜: ${record.totalBalanceInv.toLocaleString()}</span>
                                      <span>å†åˆ†é…: ${record.totalBalanceAlloc?.toLocaleString() || 0}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                              
                              <div className="flex items-center gap-2 w-full xl:w-auto mt-2 xl:mt-0 pt-2 xl:pt-0 border-t xl:border-0 border-gray-200">
                                {record.incomes && ( 
                                   <button onClick={() => loadBudgetRecord(record)} className="flex-1 xl:flex-none px-3 py-1.5 bg-white border border-purple-300 text-purple-700 text-sm font-bold rounded hover:bg-purple-100 transition-colors flex items-center justify-center gap-1"><Download size={14}/> è¼‰å…¥æ˜ç´°</button>
                                )}
                                <button onClick={() => deleteRecord(record.id)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash2 size={18} /></button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}
            
            {currentView === 'emergency' && <EmergencyFundView db={db} user={user} appId={appId} />}
            {currentView === 'bonus' && <BonusAllocationView db={db} user={user} appId={appId} onImport={handleImportBonus} />}
            {currentView === 'health' && <HealthCheckView db={db} user={user} appId={appId} savedMonthlyRecords={savedRecords} />}

          </div>
        </div>
      );
    }

    // å°‡ App æ¸²æŸ“åˆ°ç•«é¢ä¸Šçš„ root ç¯€é»
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>let app, auth, db;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

try {
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
  if (firebaseConfig) {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }
} catch (error) {
  console.error("Firebase init failed:", error);
}

// ==========================================
// å…±ç”¨è¡¨æ ¼å…ƒä»¶
// ==========================================
const SelectableTable = ({ title, items, setter, colorClass, handleUpdate, handleDelete, handleAdd }) => (
  <div className={`bg-white rounded-xl shadow-sm border ${colorClass} overflow-hidden flex flex-col`}>
    <div className={`px-4 py-2 font-bold text-center border-b ${colorClass.replace('border-', 'bg-').replace('-200', '-100')} text-gray-800`}>
      {title}
    </div>
    <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
      <div className="w-2/5 p-2 text-center border-r border-gray-200">æ”¯å‡ºé …ç›®</div>
      <div className="w-2/5 p-2 text-center border-r border-gray-200">é ä¼°é‡‘é¡</div>
      <div className="w-1/5 p-2 text-center">è¨ˆå…¥åº•ç·š</div>
    </div>
    <div className="flex-1 p-2 space-y-2">
      {items.map(item => (
        <div key={item.id} className="flex items-center gap-2 group relative">
          <input type="text" value={item.name} onChange={e => handleUpdate(setter, item.id, 'name', e.target.value)} className="w-2/5 p-1.5 text-sm border rounded focus:ring-1 bg-transparent" placeholder="é …ç›®"/>
          <input type="number" value={item.amount} onChange={e => handleUpdate(setter, item.id, 'amount', e.target.value)} className="w-2/5 p-1.5 text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="é‡‘é¡"/>
          <button onClick={() => handleUpdate(setter, item.id, 'included', !item.included)} className={`w-1/5 flex justify-center items-center transition-colors ${item.included ? 'text-pink-600' : 'text-gray-300 hover:text-pink-300'}`}>
            {item.included ? <CheckSquare size={20}/> : <Square size={20}/>}
          </button>
          <button onClick={() => handleDelete(setter, item.id)} className="absolute -left-6 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity"><Trash2 size={14}/></button>
        </div>
      ))}
      <button onClick={() => handleAdd(setter)} className="w-full py-1.5 text-xs text-gray-400 hover:text-pink-600 bg-gray-50 rounded transition-colors flex justify-center items-center gap-1"><Plus size={14}/> æ–°å¢é …ç›®</button>
    </div>
  </div>
);

const StatusRow = ({ label, value, onChange, placeholder = "-" }) => (
  <div className="flex border-b border-purple-100 last:border-0 bg-white group">
    <div className="w-[45%] md:w-1/2 p-2 bg-purple-50/50 text-gray-700 font-semibold text-xs md:text-sm flex items-center justify-center border-r border-purple-100 text-center tracking-wide">{label}</div>
    <div className="w-[55%] md:w-1/2 p-1">
      <input type="text" value={value} onChange={e => onChange(e.target.value)} className="w-full p-1 text-center text-sm border-0 focus:ring-2 focus:ring-purple-300 rounded text-gray-700 font-bold" placeholder={placeholder} />
    </div>
  </div>
);

const ArrayTable = ({ title, columns, items, setter, totalLabel, totalValue, defaultNewObj, handleUpdateArr, handleDelArr, handleAddArr }) => (
  <div className="border border-gray-200 rounded-lg overflow-hidden flex flex-col bg-white shadow-sm hover:shadow-md transition-shadow">
    <div className="bg-gray-100 px-4 py-2 font-bold text-gray-800 text-center border-b border-gray-200 text-sm md:text-base">{title}</div>
    <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
       {columns.map((col, i) => <div key={i} className={`p-2 text-center border-r border-gray-200 last:border-0 ${col.width}`}>{col.label}</div>)}
    </div>
    <div className="flex-1">
       {items.map((item) => (
         <div key={item.id} className="flex border-b border-gray-100 last:border-0 group relative hover:bg-purple-50/30">
           {columns.map((col, i) => (
              <div key={i} className={`p-1 border-r border-gray-100 last:border-0 flex items-center justify-center ${col.width}`}>
                 {col.render(item, (val) => handleUpdateArr(setter, item.id, col.field, val))}
              </div>
           ))}
           <button onClick={() => handleDelArr(setter, item.id)} className="absolute -right-6 md:-right-8 top-1/2 -translate-y-1/2 p-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14}/></button>
         </div>
       ))}
    </div>
    <div className="p-1 border-b border-gray-100">
       <button onClick={() => handleAddArr(setter, defaultNewObj)} className="w-full py-1.5 text-xs text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded transition-colors flex items-center justify-center gap-1"><Plus size={14} /> æ–°å¢åˆ—</button>
    </div>
    {totalLabel && (
       <div className="flex bg-purple-50 font-bold text-sm">
          <div className="flex-1 p-2 text-center text-purple-800 border-r border-purple-100">{totalLabel}</div>
          <div className="flex-1 p-2 text-center text-purple-800">${totalValue.toLocaleString()}</div>
       </div>
    )}
  </div>
);

const ExpenseTable = ({ title, items, setter, total, icon: Icon, colorClass, handleUpdateItem, handleDeleteItem, handleAddItem, accounts }) => (
  <div className={`bg-white rounded-xl shadow-sm border ${colorClass} overflow-hidden`}>
    <div className={`px-4 py-3 border-b flex items-center justify-between ${colorClass.replace('border-', 'bg-').replace('-200', '-50')}`}>
      <h3 className="font-bold flex items-center gap-2 text-gray-800"><Icon size={18} className="text-gray-600" />{title}</h3>
      <span className="font-bold text-gray-800">${total.toLocaleString()}</span>
    </div>
    <div className="p-2">
      {items.map((item) => (
        <div key={item.id} className="flex gap-2 mb-2 items-center">
          <input type="text" placeholder="é …ç›®åç¨±" value={item.name} onChange={(e) => handleUpdateItem(setter, item.id, 'name', e.target.value)} className="flex-1 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300"/>
          
          <select 
            value={item.account || ''} 
            onChange={(e) => handleUpdateItem(setter, item.id, 'account', e.target.value)} 
            className="w-24 md:w-32 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300 bg-white text-gray-700"
          >
            <option value="" className="text-gray-400">è«‹é¸æ“‡å¸³æˆ¶</option>
            {accounts.map(acc => <option key={acc.id} value={acc.name}>{acc.name}</option>)}
          </select>

          <input type="number" placeholder="é‡‘é¡" value={item.amount === 0 ? 0 : (item.amount || '')} onChange={(e) => handleUpdateItem(setter, item.id, 'amount', e.target.value === '' ? '' : Number(e.target.value))} className="w-24 p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300"/>
          <button onClick={() => handleDeleteItem(setter, item.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={16} /></button>
        </div>
      ))}
      <button onClick={() => handleAddItem(setter)} className="w-full py-2 mt-1 text-sm text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg flex items-center justify-center gap-1 transition-colors"><Plus size={16} /> æ–°å¢é …ç›®</button>
    </div>
  </div>
);

const MasterDebtTable = ({ masterDebts, setMasterDebts, setDebts, setFixedExpenses, handleUpdateItem, handleDeleteItem, handleAddItem, totalMasterDebt, accounts }) => (
  <div className="bg-white rounded-xl shadow-sm border border-orange-200 overflow-hidden mb-6">
    <div className="px-4 py-3 border-b bg-orange-50 flex items-center justify-between">
      <div className="flex flex-col">
        <h3 className="font-bold flex items-center gap-2 text-gray-800"><ClipboardList size={18} className="text-gray-600" />å®šæœŸæ‰£æ¬¾èˆ‡å‚µå‹™æ¸…å–® (è‡ªå‹•åˆ†æµ)</h3>
        <span className="text-xs text-gray-500 mt-1">ï¼Šåˆ—å‡ºæ‰€æœ‰å®šæœŸæ‰£æ¬¾ï¼Œé»é¸å³å´ã€Œå…¥è² å‚µã€æˆ–ã€Œå…¥å›ºå®šã€è‡ªå‹•åˆ†é…è‡³ä¸‹æ–¹å€å¡Šã€‚</span>
      </div>
      <div className="text-right">
        <div className="text-xs text-gray-500">ç¸½è¨ˆ</div>
        <span className="font-bold text-gray-800">${totalMasterDebt.toLocaleString()}</span>
      </div>
    </div>
    <div className="p-2 overflow-x-auto">
      <table className="w-full text-sm text-left min-w-[650px]">
        <thead className="text-xs text-gray-500 bg-gray-50">
          <tr>
            <th className="px-2 py-2 w-[22%]">é …ç›®</th><th className="px-2 py-2 w-[18%]">æ‰£æ¬¾å¸³æˆ¶</th><th className="px-2 py-2 w-[15%]">æ¯æœˆæ‡‰ç¹³</th><th className="px-2 py-2 w-[15%]">å‚™è¨» (å¦‚:æœŸæ•¸)</th><th className="px-2 py-2 w-[12%]">æ‰£æ¬¾æ—¥</th><th className="px-2 py-2 text-center">åˆ†é… / åˆªé™¤</th>
          </tr>
        </thead>
        <tbody>
          {masterDebts.map((item) => (
            <tr key={item.id} className="border-b border-gray-50 last:border-0 hover:bg-orange-50/30">
              <td className="px-1 py-1"><input type="text" placeholder="é …ç›®åç¨±" value={item.name} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'name', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
              
              <td className="px-1 py-1">
                <select value={item.account || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'account', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-white text-gray-700">
                  <option value="" className="text-gray-400">è«‹é¸æ“‡</option>
                  {accounts.map(acc => <option key={acc.id} value={acc.name}>{acc.name}</option>)}
                </select>
              </td>

              <td className="px-1 py-1"><input type="number" placeholder="é‡‘é¡" value={item.amount === 0 ? 0 : (item.amount || '')} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'amount', e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
              <td className="px-1 py-1"><input type="text" placeholder="å‚™è¨»" value={item.note || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'note', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
              <td className="px-1 py-1"><input type="text" placeholder="ç¹³æ¬¾æ—¥" value={item.dueDate || ''} onChange={(e) => handleUpdateItem(setMasterDebts, item.id, 'dueDate', e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 bg-transparent" /></td>
              <td className="px-1 py-1 flex justify-center items-center gap-1">
                <button onClick={() => { if(!item.name && !item.amount) return; setDebts(prev => [...prev.filter(i=>i.name||i.amount), { id: Date.now(), name: item.name, amount: item.amount, account: item.account }]); setMasterDebts(prev => prev.filter(d => d.id !== item.id)); }} className="px-2 py-1 text-xs bg-red-100 text-red-600 hover:bg-red-200 rounded font-bold transition-colors whitespace-nowrap">å…¥è² å‚µ</button>
                <button onClick={() => { if(!item.name && !item.amount) return; setFixedExpenses(prev => [...prev.filter(i=>i.name||i.amount), { id: Date.now(), name: item.name, amount: item.amount, account: item.account }]); setMasterDebts(prev => prev.filter(d => d.id !== item.id)); }} className="px-2 py-1 text-xs bg-blue-100 text-blue-600 hover:bg-blue-200 rounded font-bold transition-colors whitespace-nowrap">å…¥å›ºå®š</button>
                <button onClick={() => handleDeleteItem(setMasterDebts, item.id)} className="p-1 text-gray-400 hover:text-red-600 rounded transition-colors"><Trash2 size={16} /></button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      <button onClick={() => handleAddItem(setMasterDebts, { name: '', amount: 0, note: '', dueDate: '', account: '' })} className="w-full py-2 mt-2 text-sm text-gray-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg flex items-center justify-center gap-1 transition-colors"><Plus size={16} /> æ–°å¢é …ç›®</button>
    </div>
  </div>
);

// === ç³»çµ±ä½¿ç”¨èªªæ˜å…ƒä»¶ ===
const InstructionsView = () => (
  <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-10 space-y-8">
    <div className="text-center mb-8">
      <h2 className="text-2xl md:text-3xl font-bold text-gray-800 tracking-wider flex justify-center items-center gap-2">
        <BookOpen className="text-purple-600" size={28}/> ç³»çµ±æ“ä½œèˆ‡ç†è²¡æŒ‡å—
      </h2>
      <p className="text-gray-500 mt-2">å”åŠ©æ‚¨å»ºç«‹ç©©å¥çš„å€‹äººèˆ‡å®¶åº­è²¡å‹™ç³»çµ±</p>
    </div>

    <div className="space-y-6 text-gray-700 leading-relaxed">
      <section className="bg-blue-50 p-5 rounded-xl border border-blue-100">
        <h3 className="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2"><CreditCard size={20}/> 1. å»ºç«‹å¸³æˆ¶ç¸½è¡¨ (æ–°åŠŸèƒ½)</h3>
        <ul className="list-disc list-inside space-y-2 ml-2">
          <li><strong>é›†ä¸­åŒ–ç®¡ç†ï¼š</strong>è«‹å…ˆå‰å¾€ã€Œå¸³æˆ¶ç¸½è¡¨ã€åˆ†é ï¼Œå°‡æ‚¨æ‰€æœ‰çš„å­˜æ¬¾éŠ€è¡Œã€é›»å­æ”¯ä»˜(LinePay/æ‚ éŠå¡)ã€è‚¡ç¥¨æˆ¶é ­ã€ç”šè‡³æŠ¼é‡‘èˆ‡æ‡‰æ”¶æ¬¾å»ºç«‹ä¸Šå»ï¼Œä¸¦å¡«å…¥ç›®å‰çš„çœŸå¯¦é¤˜é¡ã€‚</li>
          <li><strong>è‡ªå‹•é€£å‹•ï¼š</strong>å»ºç«‹å¥½å¾Œï¼Œå…¶ä»–åˆ†é çš„è¡¨æ ¼éƒ½æœƒè‡ªå‹•é•·å‡ºä¸‹æ‹‰é¸å–®è®“æ‚¨é»é¸ï¼Œå†ä¹Ÿä¸ç”¨æ‰‹å‹•è¼¸å…¥å¸³æˆ¶åç¨±ï¼</li>
        </ul>
      </section>

      <section className="bg-purple-50 p-5 rounded-xl border border-purple-100">
        <h3 className="text-lg font-bold text-purple-900 mb-3 flex items-center gap-2"><LayoutDashboard size={20}/> 2. æ¯æœˆé ç®—åˆ†é…</h3>
        <ul className="list-disc list-inside space-y-2 ml-2">
          <li><strong>è™›æ“¬ä¿¡å°æ³•ï¼š</strong>å¡«å¯«å„é …æ”¶æ”¯æ™‚ï¼Œé€éä¸‹æ‹‰é¸å–®æŒ‡å®šè³‡é‡‘æµå‹•çš„å¸³æˆ¶ã€‚ç³»çµ±æœƒåœ¨å·¦ä¸‹æ–¹è‡ªå‹•å¹«æ‚¨è¨ˆç®—æ¯å€‹å¸³æˆ¶çš„ã€Œé è¨ˆæ·¨è®Šå‹•ã€èˆ‡ã€Œçµç®—å¾Œçš„å³æ™‚é¤˜é¡ã€ã€‚</li>
          <li><strong>æ ¸å¿ƒåˆ†é…é‚è¼¯ï¼š</strong>ç³»çµ±æ¡ç”¨é›¶åŸºé ç®—æ¦‚å¿µï¼Œä»¥ã€Œç¸½æ”¶å…¥ - è² å‚µ - å›ºå®šæ”¯å‡º - æŠ•è³‡ç†è²¡ = å¯ç”¨è³‡é‡‘ã€ï¼Œä¸¦ä¾æ“šæ‚¨è¨­å®šçš„å„²è“„æ¯”ä¾‹ï¼Œè‡ªå‹•è¨ˆç®—å‡ºã€Œæœ¬æœˆæ‡‰å­˜é‡‘é¡ã€èˆ‡å‰©é¤˜çš„ã€Œç”Ÿæ´»è²»é¡åº¦ã€ã€‚</li>
        </ul>
      </section>

      <section className="bg-pink-50 p-5 rounded-xl border border-pink-100">
        <h3 className="text-lg font-bold text-pink-900 mb-3 flex items-center gap-2"><ShieldAlert size={20}/> 3. è²¡å‹™å®‰å…¨ç¶² (é å‚™é‡‘è©¦ç®—)</h3>
        <ul className="list-disc list-inside space-y-2 ml-2">
          <li><strong>è©•ä¼°æœ€ä½ç”Ÿæ´»åº•ç·šï¼š</strong>åˆ—å‡ºæ—¥å¸¸é–‹éŠ·å¾Œï¼Œ<strong>åƒ…å‹¾é¸ã€Œä¸å¯ä¸­æ–·ã€èˆ‡ã€Œç¶­æŒåŸºæœ¬ç”Ÿæ´»å¿…éœ€ã€</strong>çš„é …ç›®ã€‚</li>
          <li><strong>è‡ªå‹•è©¦ç®—ç›®æ¨™ï¼š</strong>ç³»çµ±æœƒä¾æ“šå‹¾é¸é …ç›®è¨ˆç®—ã€Œæ¯æœˆåŸºæœ¬ç”Ÿæ´»åº•ç·šã€ï¼Œä¸¦è‡ªå‹•æ¨ç®—å‡º 6 å€‹æœˆçš„å®‰å…¨æº–å‚™é‡‘ç›®æ¨™é‡‘é¡ã€‚</li>
        </ul>
      </section>

      <section className="bg-yellow-50 p-5 rounded-xl border border-yellow-100">
        <h3 className="text-lg font-bold text-yellow-900 mb-3 flex items-center gap-2"><Gift size={20}/> 4. é¡å¤–æ”¶å…¥ / çé‡‘è¦åŠƒ</h3>
        <ul className="list-disc list-inside space-y-2 ml-2">
          <li><strong>ç„¡ç¸«åŒ¯å…¥ä¸»è¡¨ï¼š</strong>è¦åŠƒå®Œæˆå¾Œï¼Œé»æ“Šã€ŒåŒ¯å…¥æœ¬æœˆé ç®—è¡¨ã€ï¼Œç³»çµ±æœƒå°‡çé‡‘è½‰ç‚ºå°ˆæ¬¾å°ˆç”¨é …ç›®è‡ªå‹•æ‰£é™¤ï¼Œç¢ºä¿ä¸æœƒå¹²æ“¾æ‚¨æ—¥å¸¸çš„ç”Ÿæ´»è²»æ¯”ä¾‹ã€‚</li>
        </ul>
      </section>

      <section className="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
        <h3 className="text-lg font-bold text-indigo-900 mb-3 flex items-center gap-2"><Activity size={20}/> 5. è²¡å‹™è¿½è¹¤èˆ‡æ­·å²ç´€éŒ„</h3>
        <ul className="list-disc list-inside space-y-2 ml-2">
          <li><strong>è³‡ç”¢è² å‚µç›¤é»ï¼š</strong>åœ¨ã€Œè²¡å‹™è¿½è¹¤ã€ä¸­å¡«å¯«æœŸåˆèˆ‡æœŸæœ«é¤˜é¡ï¼Œç³»çµ±æœƒè‡ªå‹•çµç®—æœ¬æœŸçš„ã€Œæ·¨è³‡ç”¢æˆé•·ã€ã€‚</li>
          <li><strong>å€é–“æ”¶æ”¯è‡ªå‹•åŠ ç¸½ï¼š</strong>åˆ©ç”¨ä¸Šæ–¹çš„ã€Œè‡ªå‹•çµç®—å€é–“è³‡æ–™ã€å·¥å…·ï¼Œé¸æ“‡æœˆä»½å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨å°‡æ­·å²çµç®—ç´€éŒ„çš„æ•¸å­—åŠ ç¸½ä¸¦å¡«å…¥å³å´è¡¨æ ¼ä¸­ï¼</li>
          <li><strong>ç„¡é™æ¬¡å­˜æª”ï¼š</strong>æ‰€æœ‰åˆ†é çš†æ”¯æ´ç„¡é™æ¬¡å­˜æª”èˆ‡éš¨æ™‚è¼‰å…¥èˆŠç´€éŒ„ã€‚</li>
        </ul>
      </section>
    </div>
  </div>
);

// === ç·Šæ€¥é å‚™é‡‘è¨ˆç®—å…ƒä»¶ ===
const EmergencyFundView = ({ db, user, appId }) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const [recordName, setRecordName] = useState(() => `${new Date().getFullYear()} é å‚™é‡‘è©•ä¼°`);
  const [savedRecords, setSavedRecords] = useState([]);

  const [fixed, setFixed] = useState([{ id: 1, name: '', amount: '', included: false }]);
  const [saving, setSaving] = useState([{ id: 1, name: '', amount: '', included: false }]);
  const [living, setLiving] = useState([{ id: 1, name: '', amount: '', included: false }]);
  const [shortDebt, setShortDebt] = useState([{ id: 1, name: '', amount: '', included: false }]);
  const [longDebt, setLongDebt] = useState([{ id: 1, name: '', amount: '', included: false }]);

  useEffect(() => {
    if (!user || !db) { setIsLoaded(true); return; }
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'emergency');
    getDoc(docRef).then(snap => {
      if (snap.exists()) {
        const data = snap.data();
        if (data.recordName) setRecordName(data.recordName);
        if (data.fixed) setFixed(JSON.parse(data.fixed));
        if (data.saving) setSaving(JSON.parse(data.saving));
        if (data.living) setLiving(JSON.parse(data.living));
        if (data.shortDebt) setShortDebt(JSON.parse(data.shortDebt));
        if (data.longDebt) setLongDebt(JSON.parse(data.longDebt));
      }
      setIsLoaded(true);
    }).catch(() => setIsLoaded(true));

    const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords');
    const unsubscribe = onSnapshot(recordsRef, (snap) => {
      const records = [];
      snap.forEach(d => records.push({ id: d.id, ...d.data() }));
      records.sort((a, b) => b.timestamp - a.timestamp);
      setSavedRecords(records);
    }, (err) => console.error(err));
    return () => unsubscribe();
  }, [user, db, appId]);

  useEffect(() => {
    if (!isLoaded || !user || !db) return;
    const timer = setTimeout(() => {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'emergency');
      setDoc(docRef, { recordName, fixed: JSON.stringify(fixed), saving: JSON.stringify(saving), living: JSON.stringify(living), shortDebt: JSON.stringify(shortDebt), longDebt: JSON.stringify(longDebt) });
    }, 1500);
    return () => clearTimeout(timer);
  }, [recordName, fixed, saving, living, shortDebt, longDebt, isLoaded, user, db, appId]);

  const handleUpdate = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  const handleAdd = (setter) => setter(prev => [...prev, { id: Date.now(), name: '', amount: '', included: false }]);
  const handleDelete = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

  const sumIncluded = (arr) => arr.filter(item => item.included).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
  const sumFixed = sumIncluded(fixed);
  const sumLiving = sumIncluded(living);
  const sumLongDebt = sumIncluded(longDebt);
  const monthStandard = sumFixed + sumLiving + sumLongDebt;
  const halfYearGoal = monthStandard * 6;

  const saveRecord = async () => {
    if (!recordName.trim()) return alert("è«‹è¼¸å…¥è©•ä¼°åç¨±");
    if (savedRecords.some(r => r.recordName === recordName)) {
      if (!window.confirm(`${recordName} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
    }
    const newRecord = { recordName, fixed: JSON.stringify(fixed), saving: JSON.stringify(saving), living: JSON.stringify(living), shortDebt: JSON.stringify(shortDebt), longDebt: JSON.stringify(longDebt), timestamp: Date.now(), halfYearGoal, monthStandard };
    if (user && db) {
      const existing = savedRecords.find(r => r.recordName === recordName);
      const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords');
      try {
        if (existing) await setDoc(doc(colRef, existing.id), newRecord);
        else await setDoc(doc(colRef, `${recordName}-${Date.now()}`), newRecord);
      } catch (e) { console.error(e); }
    } else {
      setSavedRecords(prev => [...prev.filter(r => r.recordName !== recordName), { id: Date.now(), ...newRecord }].sort((a,b) => b.timestamp - a.timestamp));
    }
  };

  const loadRecord = (record) => {
    if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.recordName}ã€å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
    setRecordName(record.recordName); setFixed(JSON.parse(record.fixed)); setSaving(JSON.parse(record.saving)); setLiving(JSON.parse(record.living)); setShortDebt(JSON.parse(record.shortDebt)); setLongDebt(JSON.parse(record.longDebt));
  };

  const deleteRecord = async (id) => {
    if (user && db) {
      try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'emergencyRecords', id.toString())); } catch(e) { console.error(e); }
    } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
  };

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-pink-100 p-4 md:p-8 space-y-6">
      <div className="text-center mb-6">
         <h2 className="text-2xl md:text-3xl font-bold text-pink-900 tracking-wider flex justify-center items-center gap-2">
           <ShieldAlert className="text-pink-500" size={28}/> è²¡å‹™å®‰å…¨ç¶² (é å‚™é‡‘è©¦ç®—)
         </h2>
         <p className="text-pink-600 text-sm mt-2">è©•ä¼°æ¯æœˆå¿…é ˆçš„æœ€ä½é–‹éŠ·ï¼Œå»ºæ§‹ç©©å¥çš„è²¡å‹™é˜²è­·ç¶²</p>
      </div>

      <div className="flex flex-wrap gap-4 bg-pink-50 p-4 rounded-xl border border-pink-200 shadow-sm">
        <div className="flex-1 min-w-[200px]">
          <label className="block text-sm font-bold text-pink-900 mb-2 flex items-center gap-1"><Calendar size={18} /> é å‚™é‡‘è©•ä¼°åç¨±</label>
          <input type="text" value={recordName} onChange={(e) => setRecordName(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026å¹´åº¦é å‚™é‡‘ã€æ›å·¥ä½œå¾Œè©•ä¼°" className="w-full p-2.5 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 font-semibold text-gray-800" />
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <SelectableTable title="å›ºå®šæ”¯å‡º" items={fixed} setter={setFixed} colorClass="border-blue-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
        <SelectableTable title="å„²è“„èˆ‡æŠ•è³‡" items={saving} setter={setSaving} colorClass="border-green-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
        <SelectableTable title="è®Šå‹•ç”Ÿæ´»è²»" items={living} setter={setLiving} colorClass="border-orange-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
        <div className="flex flex-col gap-4 md:gap-6">
          <SelectableTable title="çŸ­æœŸè² å‚µ (1å¹´å…§çµæ¸…)" items={shortDebt} setter={setShortDebt} colorClass="border-red-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
          <SelectableTable title="é•·æœŸè² å‚µ (å¦‚ï¼šæˆ¿è²¸/å­¸è²¸/ä¿¡è²¸)" items={longDebt} setter={setLongDebt} colorClass="border-purple-200" handleUpdate={handleUpdate} handleDelete={handleDelete} handleAdd={handleAdd} />
        </div>
      </div>

      <div className="mt-8 bg-pink-50 rounded-xl p-6 border border-pink-200">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div className="space-y-4 border-b md:border-b-0 md:border-r border-pink-200 pb-4 md:pb-0 md:pr-6">
            <h3 className="font-bold text-pink-900 text-lg border-b border-pink-200 pb-2">æ¯æœˆåŸºæœ¬ç”Ÿæ´»åº•ç·š</h3>
            <div className="flex justify-between items-center text-gray-700"><span>å›ºå®šæ”¯å‡º (æœ‰å‹¾é¸)</span><span>${sumFixed.toLocaleString()}</span></div>
            <div className="flex justify-between items-center text-gray-700"><span>ç”Ÿæ´»é–‹éŠ· (æœ‰å‹¾é¸)</span><span>${sumLiving.toLocaleString()}</span></div>
            <div className="flex justify-between items-center text-gray-700 border-b border-pink-200 pb-2"><span>å‚µå‹™é‚„æ¬¾ (æœ‰å‹¾é¸)</span><span>${sumLongDebt.toLocaleString()}</span></div>
            <div className="flex justify-between items-center font-bold text-xl text-pink-700"><span>æœ€ä½éœ€æ±‚ç¸½è¨ˆ</span><span>${monthStandard.toLocaleString()}</span></div>
          </div>
          <div className="flex flex-col justify-center space-y-4">
             <div className="bg-white p-4 rounded-lg shadow-sm border border-pink-100">
               <div className="text-sm text-gray-500 font-bold mb-1">è¨ˆç®—è©•ä¼°æº–å‰‡å»ºè­°ï¼š</div>
               <ol className="text-xs text-gray-600 list-decimal list-inside space-y-1">
                 <li><span className="text-red-500 font-bold">ä¸å¯ä¸­æ–·</span>çš„å›ºå®šæ”¯å‡ºï¼ˆå¦‚æˆ¿è²¸ã€ç§Ÿé‡‘ã€åŸºæœ¬ä¿éšªï¼‰</li>
                 <li><span className="text-red-500 font-bold">ç¶­æŒç”Ÿå­˜</span>çš„å¿…è¦é–‹éŠ·ï¼ˆå¦‚åŸºæœ¬ä¼™é£Ÿè²»ã€é€šå‹¤è²»ï¼‰</li>
                 <li>éæ€¥è¿«æ€§çš„å¨›æ¨‚ã€è³¼ç‰©æˆ–æŠ•è³‡é …ç›®å»ºè­°å–æ¶ˆå‹¾é¸</li>
                 <li>ç›®æ¨™æº–å‚™é‡‘å»ºè­°å­˜æ”¾åœ¨é«˜æµå‹•æ€§çš„æ´»å­˜å¸³æˆ¶ä¸­</li>
               </ol>
             </div>
             <div className="bg-pink-600 text-white p-4 rounded-xl shadow-md text-center">
               <div className="text-pink-100 text-sm mb-1">æ¯æœˆæœ€ä½éœ€æ±‚ ${monthStandard.toLocaleString()} Ã— 6å€‹æœˆ =</div>
               <div className="text-2xl md:text-3xl font-black tracking-wide flex items-center justify-center gap-2">
                 åŠå¹´å®‰å…¨é å‚™é‡‘ ${halfYearGoal.toLocaleString()}
               </div>
             </div>
          </div>
        </div>
      </div>

      <button onClick={saveRecord} className="w-full py-4 bg-pink-500 hover:bg-pink-600 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
        <Save size={24} /> å„²å­˜ã€Œ{recordName}ã€è©•ä¼°ç´€éŒ„
      </button>

      {savedRecords.length > 0 && (
        <div className="bg-white p-5 rounded-xl shadow-sm border border-pink-200 mt-8">
          <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-pink-600"/>æ­·å²é å‚™é‡‘è©•ä¼°ç´€éŒ„</h2>
          <div className="space-y-3">
            {savedRecords.map(record => (
              <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-pink-300 transition-colors">
                <div>
                  <span className="font-bold text-pink-800 text-lg">{record.recordName}</span>
                  <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()}</div>
                  <div className="text-sm font-bold text-pink-600 mt-1">ç›®æ¨™é‡‘é¡: ${(record.halfYearGoal || 0).toLocaleString()}</div>
                </div>
                <div className="flex items-center gap-3 w-full md:w-auto">
                  <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-pink-300 text-pink-700 text-sm font-bold rounded-lg hover:bg-pink-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                  <button onClick={() => deleteRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20} /></button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// === å¹´çµ‚/çé‡‘åˆ†é…å…ƒä»¶ ===
const BonusAllocationView = ({ db, user, appId, onImport }) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const [recordName, setRecordName] = useState(() => `${new Date().getFullYear()} çé‡‘è¦åŠƒ`);
  const [savedRecords, setSavedRecords] = useState([]);
  
  const [bonusAmount, setBonusAmount] = useState('');
  const [status, setStatus] = useState('has_debt'); 
  const [allocations, setAllocations] = useState([]);

  useEffect(() => {
    if (!user || !db) { setIsLoaded(true); return; }
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bonus');
    getDoc(docRef).then(snap => {
      if (snap.exists()) {
        const data = snap.data();
        if (data.recordName) setRecordName(data.recordName);
        if (data.bonusAmount !== undefined) setBonusAmount(data.bonusAmount);
        if (data.status) setStatus(data.status);
        if (data.allocations) setAllocations(JSON.parse(data.allocations));
      }
      setIsLoaded(true);
    }).catch(() => setIsLoaded(true));

    const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords');
    const unsubscribe = onSnapshot(recordsRef, (snap) => {
      const records = [];
      snap.forEach(d => records.push({ id: d.id, ...d.data() }));
      records.sort((a, b) => b.timestamp - a.timestamp);
      setSavedRecords(records);
    }, (err) => console.error(err));
    return () => unsubscribe();
  }, [user, db, appId]);

  useEffect(() => {
    if (!isLoaded) return;
    let template = [];
    if (status === 'has_debt') {
      template = [
        { id: 1, name: 'åŠ é€Ÿæ¸…å„Ÿå‚µå‹™', desc: 'å„ªå…ˆè™•ç†é«˜æ¯è² å‚µ(å¦‚å¡å‚µ/ä¿¡è²¸)', amount: '' },
        { id: 2, name: 'é ç•™å¹´åº¦æ”¯å‡º', desc: 'å¹´åº¦ä¿è²»ã€ç¨…é‡‘é ç®—', amount: '' },
        { id: 3, name: 'é©åº¦è‡ªæˆ‘çŠ’è³', desc: 'ææ’¥å°æ¯”ä¾‹ä½œç‚ºçå‹µï¼Œé¿å…å ±å¾©æ€§æ¶ˆè²»', amount: '' },
        { id: 4, name: 'è½‰å…¥å„²è“„', desc: 'å‰©é¤˜è³‡é‡‘è½‰å…¥å­˜æ¬¾', amount: '' },
      ];
    } else if (status === 'no_ef') {
      template = [
        { id: 1, name: 'å»ºç«‹å®‰å…¨å­˜æ¬¾', desc: 'å„ªå…ˆè£œè¶³ç·Šæ€¥é å‚™é‡‘', amount: '' },
        { id: 2, name: 'é ç•™å¹´åº¦æ”¯å‡º', desc: 'å¹´åº¦ä¿è²»ã€ç¨…é‡‘é ç®—', amount: '' },
        { id: 3, name: 'é©åº¦è‡ªæˆ‘çŠ’è³', desc: 'ææ’¥åˆç†æ¯”ä¾‹ä½œç‚ºç”Ÿæ´»èª¿åŠ‘', amount: '' },
      ];
    } else if (status === 'has_ef') {
      template = [
        { id: 1, name: 'æ“´å¤§è³‡ç”¢æŠ•è³‡', desc: 'è½‰å…¥æŠ•è³‡å¸³æˆ¶åŠ é€Ÿè³‡ç”¢ç´¯ç©', amount: '' },
        { id: 2, name: 'å¤§ç­†é ç®—æº–å‚™', desc: 'æ—…éŠåŸºé‡‘ã€å¤§å‹æ¡è³¼', amount: '' },
        { id: 3, name: 'è‡ªæˆ‘æŠ•è³‡èˆ‡çå‹µ', desc: 'é€²ä¿®èª²ç¨‹æˆ–å€‹äººçŠ’è³', amount: '' },
      ];
    }
    if (allocations.length === 0 || allocations[0]?.name !== template[0].name) {
      setAllocations(template);
    }
  }, [status, isLoaded]);

  useEffect(() => {
    if (!isLoaded || !user || !db) return;
    const timer = setTimeout(() => {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'bonus');
      setDoc(docRef, { recordName, bonusAmount, status, allocations: JSON.stringify(allocations) });
    }, 1500);
    return () => clearTimeout(timer);
  }, [recordName, bonusAmount, status, allocations, isLoaded, user, db, appId]);

  const saveRecord = async () => {
    if (!recordName.trim()) return alert("è«‹è¼¸å…¥è¦åŠƒåç¨±");
    if (savedRecords.some(r => r.recordName === recordName)) {
      if (!window.confirm(`${recordName} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
    }
    const newRecord = { recordName, bonusAmount, status, allocations: JSON.stringify(allocations), timestamp: Date.now() };
    if (user && db) {
      const existing = savedRecords.find(r => r.recordName === recordName);
      const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords');
      try {
        if (existing) await setDoc(doc(colRef, existing.id), newRecord);
        else await setDoc(doc(colRef, `${recordName}-${Date.now()}`), newRecord);
      } catch (e) { console.error(e); }
    } else {
      setSavedRecords(prev => [...prev.filter(r => r.recordName !== recordName), { id: Date.now(), ...newRecord }].sort((a,b) => b.timestamp - a.timestamp));
    }
  };

  const loadRecord = (record) => {
    if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.recordName}ã€å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
    setRecordName(record.recordName); setBonusAmount(record.bonusAmount); setStatus(record.status); setAllocations(JSON.parse(record.allocations));
  };

  const deleteRecord = async (id) => {
    if (user && db) {
      try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'bonusRecords', id.toString())); } catch(e) { console.error(e); }
    } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
  };

  const handleUpdateAlloc = (id, value) => {
    setAllocations(prev => prev.map(item => item.id === id ? { ...item, amount: value } : item));
  };

  const totalAllocated = allocations.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
  const remaining = Number(bonusAmount || 0) - totalAllocated;

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-yellow-200 p-4 md:p-8 space-y-6">
      <div className="text-center mb-6">
         <h2 className="text-2xl md:text-3xl font-bold text-yellow-900 tracking-wider flex justify-center items-center gap-2">
           <Gift className="text-yellow-500" size={28}/> é¡å¤–æ”¶å…¥ / çé‡‘è¦åŠƒ
         </h2>
         <p className="text-yellow-700 text-sm mt-2">æ ¹æ“šæ‚¨ç›®å‰çš„è²¡å‹™éšæ®µï¼Œæä¾›æœ€ä½³åŒ–çš„è³‡é‡‘åˆ†é…ç­–ç•¥</p>
      </div>

      <div className="flex flex-wrap gap-4 bg-yellow-50 p-4 rounded-xl border border-yellow-200 shadow-sm">
        <div className="flex-1 min-w-[200px]">
          <label className="block text-sm font-bold text-yellow-900 mb-2 flex items-center gap-1"><Calendar size={18} /> çé‡‘è¦åŠƒåç¨±</label>
          <input type="text" value={recordName} onChange={(e) => setRecordName(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026ä¸­ç§‹çé‡‘ã€Q3ç¸¾æ•ˆçé‡‘" className="w-full p-2.5 border border-yellow-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 font-semibold text-gray-800" />
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
        <div className="md:col-span-5 space-y-6">
          <div className="bg-yellow-50 p-5 rounded-xl border border-yellow-200">
            <label className="block text-sm font-bold text-yellow-800 mb-2">ğŸ’° ç¸½è¨ˆçé‡‘ / é¡å¤–æ”¶å…¥é‡‘é¡</label>
            <input type="number" value={bonusAmount} onChange={e => setBonusAmount(e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-3 text-xl font-bold text-yellow-900 border-2 border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:outline-none" placeholder="è«‹è¼¸å…¥ç¸½é¡" />
          </div>

          <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
            <label className="block text-sm font-bold text-gray-800 mb-3">ğŸ” é¸æ“‡æ‚¨ç¾éšæ®µçš„è²¡å‹™é‡å¿ƒï¼š</label>
            <div className="space-y-3">
              <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'has_debt' ? 'border-red-400 bg-red-50' : 'border-gray-100 hover:border-gray-300'}`}>
                <div className="flex items-center gap-2">
                  <input type="radio" name="status" checked={status === 'has_debt'} onChange={() => setStatus('has_debt')} className="text-red-500 focus:ring-red-500"/>
                  <span className="font-bold text-gray-800">å„ªå…ˆæ¸…å„Ÿå‚µå‹™</span>
                </div>
                <p className="text-xs text-gray-500 ml-6 mt-1">ä»æœ‰é«˜å¾ªç’°åˆ©æ¯çš„è² å‚µï¼ˆå¦‚å¡å‚µã€ä¿¡è²¸ç­‰ï¼‰</p>
              </label>
              <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'no_ef' ? 'border-blue-400 bg-blue-50' : 'border-gray-100 hover:border-gray-300'}`}>
                <div className="flex items-center gap-2">
                  <input type="radio" name="status" checked={status === 'no_ef'} onChange={() => setStatus('no_ef')} className="text-blue-500 focus:ring-blue-500"/>
                  <span className="font-bold text-gray-800">å»ºæ§‹è²¡å‹™å®‰å…¨ç¶²</span>
                </div>
                <p className="text-xs text-gray-500 ml-6 mt-1">å°šæœªå­˜æ»¿ 6 å€‹æœˆä»¥ä¸Šçš„ç·Šæ€¥é å‚™é‡‘</p>
              </label>
              <label className={`block p-3 border-2 rounded-lg cursor-pointer transition-all ${status === 'has_ef' ? 'border-green-400 bg-green-50' : 'border-gray-100 hover:border-gray-300'}`}>
                <div className="flex items-center gap-2">
                  <input type="radio" name="status" checked={status === 'has_ef'} onChange={() => setStatus('has_ef')} className="text-green-500 focus:ring-green-500"/>
                  <span className="font-bold text-gray-800">æ“´å¤§è³‡ç”¢èˆ‡æŠ•è³‡</span>
                </div>
                <p className="text-xs text-gray-500 ml-6 mt-1">å·²æœ‰å……è¶³å‚™ç”¨é‡‘ï¼Œå¯è‘—çœ¼é•·æœŸè³‡ç”¢å¢å€¼</p>
              </label>
            </div>
          </div>
        </div>

        <div className="md:col-span-7">
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full flex flex-col">
            <div className="bg-gray-100 px-4 py-3 font-bold text-gray-800 text-center border-b border-gray-200 flex justify-between items-center">
              <span>å»ºè­°åˆ†é…é †åº</span>
              <span className={`text-sm px-2 py-1 rounded-full ${status === 'has_debt' ? 'bg-red-100 text-red-700' : status === 'no_ef' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                {status === 'has_debt' ? 'ç†å‚µå„ªå…ˆæœŸ' : status === 'no_ef' ? 'é˜²è­·ç¶²å»ºæ§‹æœŸ' : 'è³‡ç”¢å¢å€¼æœŸ'}
              </span>
            </div>
            <div className="flex bg-gray-50 border-b border-gray-200 text-sm font-semibold text-gray-500">
              <div className="w-16 p-3 text-center border-r border-gray-200">é †åº</div>
              <div className="flex-1 p-3 border-r border-gray-200">è¦åŠƒé …ç›® / èªªæ˜</div>
              <div className="w-32 p-3 text-center">é…ç½®é‡‘é¡</div>
            </div>
            <div className="flex-1">
              {allocations.map((item, index) => (
                <div key={item.id} className="flex border-b border-gray-100 last:border-0 hover:bg-yellow-50/30 transition-colors">
                  <div className="w-16 p-3 flex items-center justify-center border-r border-gray-100 font-bold text-gray-400 text-lg">{index + 1}</div>
                  <div className="flex-1 p-3 border-r border-gray-100 flex flex-col justify-center">
                    <span className="font-bold text-gray-800">{item.name}</span>
                    <span className="text-xs text-gray-500">{item.desc}</span>
                  </div>
                  <div className="w-32 p-2 flex items-center justify-center">
                    <input type="number" value={item.amount} onChange={e => handleUpdateAlloc(item.id, e.target.value)} placeholder="è¨­å®šé‡‘é¡" className="w-full p-2 text-center border-b-2 border-gray-200 focus:border-yellow-500 focus:outline-none bg-transparent font-bold text-gray-700" />
                  </div>
                </div>
              ))}
            </div>
            <div className="bg-gray-50 p-4 border-t border-gray-200">
              <div className="flex justify-between items-center mb-2">
                <span className="text-gray-600 font-bold">å·²åˆ†é…ç¸½é¡</span>
                <span className="font-bold text-gray-800">${totalAllocated.toLocaleString()}</span>
              </div>
              <div className="flex justify-between items-center text-lg">
                <span className="font-bold text-gray-800">å‰©é¤˜æœªåˆ†é…é¡åº¦</span>
                <span className={`font-black ${remaining === 0 ? 'text-green-600' : remaining < 0 ? 'text-red-500' : 'text-yellow-600'}`}>${remaining.toLocaleString()}</span>
              </div>
              {remaining < 0 && <p className="text-xs text-red-500 text-right mt-1">âš ï¸ è­¦å‘Šï¼šé…ç½®ç¸½é¡å·²è¶…éçé‡‘ç¸½æ•¸ï¼</p>}
              {remaining === 0 && Number(bonusAmount) > 0 && <p className="text-xs text-green-600 text-right mt-1 flex items-center justify-end gap-1"><CheckCircle2 size={14}/> è³‡é‡‘é…ç½®å®Œæˆï¼</p>}
              
              <button onClick={() => onImport(Number(bonusAmount || 0), allocations)} className="w-full mt-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-sm flex justify-center items-center gap-2 transition-colors">
                åŒ¯å…¥æœ¬æœˆé ç®—è¡¨ <ArrowRight size={18} />
              </button>
            </div>
          </div>
        </div>
      </div>

      <button onClick={saveRecord} className="w-full py-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
        <Save size={24} /> å„²å­˜ã€Œ{recordName}ã€è¦åŠƒç´€éŒ„
      </button>

      {savedRecords.length > 0 && (
        <div className="bg-white p-5 rounded-xl shadow-sm border border-yellow-200 mt-8">
          <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-yellow-600"/>æ­·å²çé‡‘è¦åŠƒç´€éŒ„</h2>
          <div className="space-y-3">
            {savedRecords.map(record => (
              <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-yellow-300 transition-colors">
                <div>
                  <span className="font-bold text-yellow-800 text-lg">{record.recordName}</span>
                  <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()}</div>
                  <div className="text-sm font-bold text-yellow-600 mt-1">ç¸½é¡: ${(record.bonusAmount || 0).toLocaleString()}</div>
                </div>
                <div className="flex items-center gap-3 w-full md:w-auto">
                  <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-yellow-300 text-yellow-700 text-sm font-bold rounded-lg hover:bg-yellow-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                  <button onClick={() => deleteRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20} /></button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// === é ç®—å¥æª¢æˆæ•ˆå…ƒä»¶ ===
const HealthCheckView = ({ db, user, appId, savedMonthlyRecords }) => {
  const [isLoaded, setIsLoaded] = useState(false);
  
  const [period, setPeriod] = useState(() => {
    const today = new Date();
    const quarter = Math.floor((today.getMonth() + 3) / 3);
    return `${today.getFullYear()}-Q${quarter} è²¡å‹™å¥æª¢`;
  });

  const [assets, setAssets] = useState([
    { id: 1, name: 'å„å®¶éŠ€è¡Œå­˜æ¬¾', pre: '', post: '' },
    { id: 2, name: 'æŠ•è³‡(è‚¡ç¥¨/ETF)', pre: '', post: '' },
    { id: 3, name: 'é›»æ”¯å¸³æˆ¶/å„²å€¼å¡', pre: '', post: '' },
    { id: 4, name: 'æŠ¼é‡‘/æ‡‰æ”¶æ¬¾', pre: '', post: '' },
  ]);
  const [liabilities, setLiabilities] = useState([
    { id: 1, name: 'ä¿¡ç”¨å¡æœªç¹³æ¬¾', pre: '', post: '' },
    { id: 2, name: 'å„é …è²¸æ¬¾', pre: '', post: '' },
    { id: 3, name: 'æ‡‰ä»˜/ä»£å¢Šæ¬¾', pre: '', post: '' },
  ]);

  const [premiumGoals, setPremiumGoals] = useState([{ id: 1, amount: '', date: '', done: false }]);
  const [fixedExpenses, setFixedExpenses] = useState([{ id: 1, name: '', amount: '' }]);
  const [budgets, setBudgets] = useState([{ id: 1, name: '', amount: '' }]);
  const [monthlyStats, setMonthlyStats] = useState([{ id: 1, name: '', amount: '' }]);
  
  const [savedHealthRecords, setSavedHealthRecords] = useState([]);

  const [importStartMonth, setImportStartMonth] = useState('');
  const [importEndMonth, setImportEndMonth] = useState('');

  useEffect(() => {
    if (!user || !db) { setIsLoaded(true); return; }
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'health');
    getDoc(docRef).then(snap => {
      if (snap.exists()) {
        const data = snap.data();
        if (data.period) setPeriod(data.period);
        if (data.assets) setAssets(JSON.parse(data.assets));
        if (data.liabilities) setLiabilities(JSON.parse(data.liabilities));
        if (data.premiumGoals) setPremiumGoals(JSON.parse(data.premiumGoals));
        if (data.fixedExpenses) setFixedExpenses(JSON.parse(data.fixedExpenses));
        if (data.budgets) setBudgets(JSON.parse(data.budgets));
        if (data.monthlyStats) setMonthlyStats(JSON.parse(data.monthlyStats));
      }
      setIsLoaded(true);
    }).catch(() => setIsLoaded(true));

    const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'healthRecords');
    const unsubscribe = onSnapshot(recordsRef, (snap) => {
      const records = [];
      snap.forEach(d => records.push({ id: d.id, ...d.data() }));
      records.sort((a, b) => b.timestamp - a.timestamp); 
      setSavedHealthRecords(records);
    }, (err) => console.error("Health records snapshot error:", err));

    return () => unsubscribe();
  }, [user, db, appId]);

  useEffect(() => {
    if (!isLoaded || !user || !db) return;
    const timer = setTimeout(() => {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'health');
      setDoc(docRef, { period, assets: JSON.stringify(assets), liabilities: JSON.stringify(liabilities), premiumGoals: JSON.stringify(premiumGoals), fixedExpenses: JSON.stringify(fixedExpenses), budgets: JSON.stringify(budgets), monthlyStats: JSON.stringify(monthlyStats) });
    }, 1500);
    return () => clearTimeout(timer);
  }, [period, assets, liabilities, premiumGoals, fixedExpenses, budgets, monthlyStats, isLoaded, user, db, appId]);

  const handleUpdateArr = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  const handleAddArr = (setter, defaultObj) => setter(prev => [...prev, { id: Date.now(), ...defaultObj }]);
  const handleDelArr = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

  const handleAutoImport = () => {
    if (!importStartMonth || !importEndMonth) return alert('è«‹å…ˆé¸æ“‡èµ·å§‹èˆ‡çµæŸæœˆä»½ï¼');
    const filteredRecords = savedMonthlyRecords.filter(r => r.month >= importStartMonth && r.month <= importEndMonth);
    if (filteredRecords.length === 0) return alert(`åœ¨ ${importStartMonth} åˆ° ${importEndMonth} å€é–“å…§ï¼Œæ‰¾ä¸åˆ°ä»»ä½•å„²å­˜éçš„ã€Œçµç®—ç´€éŒ„ã€ï¼\nè«‹ç¢ºèªæ‚¨åœ¨ã€Œé ç®—åˆ†é…ã€åˆ†é ä¸­æ˜¯å¦æœ‰å„²å­˜éé€™å¹¾å€‹æœˆçš„è³‡æ–™ã€‚`);

    let sumIncome = 0, sumFixed = 0, sumDebt = 0, sumSavings = 0, sumLiving = 0;
    const newMonthlyStats = [];
    const sortedFiltered = [...filteredRecords].sort((a, b) => a.month.localeCompare(b.month));

    sortedFiltered.forEach((r, idx) => {
      sumIncome += Number(r.totalIncome || 0); sumFixed += Number(r.totalFixed || 0); sumDebt += Number(r.totalDebt || 0); sumSavings += Number(r.savingsAmount || 0); sumLiving += Number(r.totalLiving || 0);
      newMonthlyStats.push({ id: Date.now() + idx, name: r.month, amount: r.totalBalanceInv || 0 });
    });

    if (window.confirm(`æ‰¾åˆ° ${filteredRecords.length} ç­†çµç®—ç´€éŒ„ã€‚\nå³å°‡è‡ªå‹•è¦†è“‹å³ä¸‹æ–¹ã€Œå¯¦éš›é ç®—åˆ†é…é‡‘é¡ã€èˆ‡ã€Œæ¯æœˆå¯¦éš›çµé¤˜çµ±è¨ˆã€å…©å€‹è¡¨æ ¼ï¼Œç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ`)) {
      setBudgets([{ id: Date.now() + 1, name: 'å€é–“ç¸½æ”¶å…¥', amount: sumIncome }, { id: Date.now() + 2, name: 'å€é–“ç¸½å„²è“„', amount: sumSavings }, { id: Date.now() + 3, name: 'ç¸½å‚µå‹™æ”¤é‚„', amount: sumDebt }, { id: Date.now() + 4, name: 'ç¸½å›ºå®šæ”¯å‡º', amount: sumFixed }, { id: Date.now() + 5, name: 'ç¸½ç”Ÿæ´»èŠ±è²»', amount: sumLiving }]);
      setMonthlyStats(newMonthlyStats.length > 0 ? newMonthlyStats : [{ id: 1, name: '', amount: '' }]);
      alert('âœ… è‡ªå‹•åŠ ç¸½èˆ‡åŒ¯å…¥å®Œæˆï¼');
    }
  };

  const saveHealthRecord = async () => {
    if (!period.trim()) return alert("è«‹è¼¸å…¥è©•ä¼°æœŸæ•¸åç¨±");
    if (savedHealthRecords.some(r => r.period === period)) {
      if (!window.confirm(`${period} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
    }
    const recordData = { period, assets: JSON.stringify(assets), liabilities: JSON.stringify(liabilities), premiumGoals: JSON.stringify(premiumGoals), fixedExpenses: JSON.stringify(fixedExpenses), budgets: JSON.stringify(budgets), monthlyStats: JSON.stringify(monthlyStats), timestamp: Date.now() };
    if (user && db) {
      const existing = savedHealthRecords.find(r => r.period === period);
      const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'healthRecords');
      try {
        if (existing && existing.id) await setDoc(doc(colRef, existing.id), recordData);
        else await setDoc(doc(colRef, `${period}-${Date.now()}`), recordData);
      } catch (e) { console.error("Save health record error:", e); }
    } else {
       setSavedHealthRecords(prev => [...prev.filter(r => r.period !== period), { id: Date.now(), ...recordData }].sort((a, b) => b.timestamp - a.timestamp));
    }
  };

  const loadRecord = (record) => {
    if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ã€Œ${record.period}ã€çš„ç´€éŒ„å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
    setPeriod(record.period);
    if (record.assets) setAssets(JSON.parse(record.assets));
    if (record.liabilities) setLiabilities(JSON.parse(record.liabilities));
    setPremiumGoals(JSON.parse(record.premiumGoals)); setFixedExpenses(JSON.parse(record.fixedExpenses)); setBudgets(JSON.parse(record.budgets)); setMonthlyStats(JSON.parse(record.monthlyStats));
  };

  const deleteHealthRecord = async (id) => {
    if (user && db) {
      try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'healthRecords', id.toString())); } catch(e) { console.error(e); }
    } else { setSavedHealthRecords(prev => prev.filter(r => r.id !== id)); }
  };

  const totalPreAssets = useMemo(() => assets.reduce((sum, item) => sum + (Number(item.pre) || 0), 0), [assets]);
  const totalPostAssets = useMemo(() => assets.reduce((sum, item) => sum + (Number(item.post) || 0), 0), [assets]);
  const totalPreLiabilities = useMemo(() => liabilities.reduce((sum, item) => sum + (Number(item.pre) || 0), 0), [liabilities]);
  const totalPostLiabilities = useMemo(() => liabilities.reduce((sum, item) => sum + (Number(item.post) || 0), 0), [liabilities]);
  
  const preNetWorth = totalPreAssets - totalPreLiabilities;
  const postNetWorth = totalPostAssets - totalPostLiabilities;
  const netWorthGrowth = postNetWorth - preNetWorth;

  const totalFixed = useMemo(() => fixedExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [fixedExpenses]);
  const totalBudgets = useMemo(() => budgets.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [budgets]);
  const totalMonthly = useMemo(() => monthlyStats.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [monthlyStats]);

  const BalanceSheetTable = ({ title, items, setter, totalPre, totalPost, defaultNewObj, colorClass }) => {
    const totalDiff = totalPost - totalPre;
    
    return (
      <div className={`border rounded-lg overflow-hidden flex flex-col bg-white shadow-sm hover:shadow-md transition-shadow ${colorClass}`}>
        <div className={`px-4 py-2 font-bold text-center border-b text-sm md:text-base ${colorClass.replace('border-', 'bg-').replace('-200', '-100').replace('-300', '-100')} text-gray-800`}>{title}</div>
        <div className="flex bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500">
           <div className="w-[34%] p-2 text-center border-r border-gray-200">é …ç›® (å¦‚: è‚¡ç¥¨ä»£è™Ÿ)</div>
           <div className="w-[22%] p-2 text-center border-r border-gray-200">æœŸåˆé‡‘é¡</div>
           <div className="w-[22%] p-2 text-center border-r border-gray-200">æœŸæœ«ç¾å€¼</div>
           <div className="w-[22%] p-2 text-center">å¢æ¸› / æç›Š</div>
        </div>
        <div className="flex-1 p-1 space-y-1">
           {items.map((item) => {
             const preVal = Number(item.pre) || 0;
             const postVal = Number(item.post) || 0;
             const diff = postVal - preVal;
             
             return (
               <div key={item.id} className="flex items-center gap-1 group relative">
                 <input type="text" value={item.name} onChange={e => handleUpdateArr(setter, item.id, 'name', e.target.value)} className="w-[34%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent" placeholder="é …ç›®"/>
                 <input type="number" value={item.pre} onChange={e => handleUpdateArr(setter, item.id, 'pre', e.target.value)} className="w-[22%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="æœŸåˆ"/>
                 <input type="number" value={item.post} onChange={e => handleUpdateArr(setter, item.id, 'post', e.target.value)} className="w-[22%] p-1.5 text-xs md:text-sm border rounded focus:ring-1 bg-transparent text-center" placeholder="æœŸæœ«"/>
                 <div className={`w-[22%] p-1.5 text-xs md:text-sm text-center font-bold ${diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-500' : 'text-gray-400'}`}>
                   {diff > 0 ? '+' : ''}{diff === 0 && (item.pre === '' && item.post === '') ? '-' : diff.toLocaleString()}
                 </div>
                 <button onClick={() => handleDelArr(setter, item.id)} className="absolute -left-5 md:-left-6 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity"><Trash2 size={14}/></button>
               </div>
             );
           })}
           <button onClick={() => handleAddArr(setter, defaultNewObj)} className="w-full py-1.5 text-xs text-gray-400 hover:text-gray-600 bg-gray-50 rounded transition-colors flex items-center justify-center gap-1 mt-1"><Plus size={14} /> æ–°å¢é …ç›®</button>
        </div>
        <div className="flex bg-gray-100 font-bold text-sm border-t border-gray-200">
           <div className="w-[34%] p-2 text-center text-gray-600 border-r border-gray-200">åˆè¨ˆ</div>
           <div className="w-[22%] p-2 text-center text-gray-800 border-r border-gray-200">${totalPre.toLocaleString()}</div>
           <div className="w-[22%] p-2 text-center text-gray-800 border-r border-gray-200">${totalPost.toLocaleString()}</div>
           <div className={`w-[22%] p-2 text-center ${totalDiff > 0 ? 'text-green-600' : totalDiff < 0 ? 'text-red-600' : 'text-gray-600'}`}>
             {totalDiff > 0 ? '+' : ''}{totalDiff.toLocaleString()}
           </div>
        </div>
      </div>
    );
  };

  return (
    <div className="bg-white rounded-2xl shadow-sm border border-purple-100 p-4 md:p-8 space-y-6 md:space-y-8">
      <div className="text-center mb-6">
         <h2 className="text-2xl md:text-3xl font-bold text-purple-900 tracking-wider">è²¡å‹™å¥åº·æŒ‡æ¨™è¿½è¹¤</h2>
         <p className="text-purple-600 text-sm mt-2">éšæ®µæ€§å›é¡§ï¼šæª¢è¦–è³‡ç”¢è² å‚µè®ŠåŒ–èˆ‡è²¡å‹™ç›®æ¨™é”æˆç‡</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-purple-50 p-4 rounded-xl border border-purple-200 shadow-sm flex flex-col justify-between">
          <label className="block text-sm font-bold text-purple-900 mb-2 flex items-center gap-1"><Calendar size={18} /> 1. è¨­å®šè©•ä¼°æœŸæ•¸åç¨±</label>
          <input type="text" value={period} onChange={(e) => setPeriod(e.target.value)} placeholder="ä¾‹å¦‚ï¼š2026å¹´ç¬¬ä¸€å­£ã€2026ä¸‹åŠå¹´" className="w-full p-2.5 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 font-semibold text-gray-800" />
          <p className="text-xs text-gray-500 mt-2">ï¼ŠæœŸåˆï¼šè©²å€é–“é–‹å§‹å‰æ‚¨çš„è³‡ç”¢ç‹€æ³ã€‚<br/>ï¼ŠæœŸæœ«ï¼šè©²å€é–“çµæŸå¾Œæ‚¨çš„æœ€æ–°ç‹€æ³ã€‚</p>
        </div>

        <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-sm flex flex-col justify-between">
          <label className="block text-sm font-bold text-blue-900 mb-2 flex items-center gap-1"><Calculator size={18} /> 2. è‡ªå‹•çµç®—å€é–“è³‡æ–™ (é¸ç”¨)</label>
          <div className="flex items-center gap-2 mb-2">
            <input type="month" value={importStartMonth} onChange={e => setImportStartMonth(e.target.value)} className="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-300" />
            <span className="text-gray-500 font-bold">è‡³</span>
            <input type="month" value={importEndMonth} onChange={e => setImportEndMonth(e.target.value)} className="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-blue-300" />
          </div>
          <button onClick={handleAutoImport} className="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg transition-colors flex items-center justify-center gap-1 shadow-sm"><Download size={16} /> è‡ªå‹•å½™æ•´æ­·å²ç´€éŒ„</button>
        </div>
      </div>
      
      <div className="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200 shadow-inner space-y-6">
        <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2 border-b border-slate-300 pb-2"><PiggyBank className="text-slate-600" /> 3. å€‹äººè³‡ç”¢è² å‚µç›¤é» (å¯è¿½è¹¤æŠ•è³‡ç¸¾æ•ˆ)</h3>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <BalanceSheetTable title="ğŸ’° ç¸½è³‡ç”¢æ¸…å–® (å¸³æˆ¶é¤˜é¡ã€å„æª”è‚¡ç¥¨æŠ•è³‡)" items={assets} setter={setAssets} totalPre={totalPreAssets} totalPost={totalPostAssets} defaultNewObj={{ name: '', pre: '', post: '' }} colorClass="border-green-300" />
          <BalanceSheetTable title="ğŸ’³ ç¸½è² å‚µæ¸…å–® (è²¸æ¬¾ã€å¡è²»ã€æ‡‰ä»˜æ¬¾)" items={liabilities} setter={setLiabilities} totalPre={totalPreLiabilities} totalPost={totalPostLiabilities} defaultNewObj={{ name: '', pre: '', post: '' }} colorClass="border-red-300" />
        </div>
        <div className="bg-white rounded-xl shadow border border-purple-200 p-4 flex flex-col md:flex-row items-center justify-between gap-4">
          <div className="text-center w-full md:w-1/3"><div className="text-sm font-bold text-gray-500 mb-1">æœŸåˆ æ·¨è³‡ç”¢ç¸½è¨ˆ</div><div className="text-xl font-bold text-gray-800">${preNetWorth.toLocaleString()}</div></div>
          <div className="hidden md:block text-2xl text-gray-300">â¡ï¸</div>
          <div className="text-center w-full md:w-1/3"><div className="text-sm font-bold text-purple-600 mb-1">æœŸæœ« æ·¨è³‡ç”¢ç¸½è¨ˆ</div><div className="text-2xl font-black text-purple-900">${postNetWorth.toLocaleString()}</div></div>
          <div className="w-full md:w-1/3 border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-4 text-center"><div className="text-xs font-bold text-gray-500 mb-1">æœ¬æœŸæ·¨è³‡ç”¢æˆé•·</div><div className={`text-lg font-bold flex items-center justify-center gap-1 ${netWorthGrowth >= 0 ? 'text-green-600' : 'text-red-500'}`}>{netWorthGrowth >= 0 ? <TrendingUp size={18}/> : <TrendingUp size={18} className="rotate-180"/>}${Math.abs(netWorthGrowth).toLocaleString()}</div></div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
         <ArrayTable title="å¹´åº¦å¤§ç­†æ”¯å‡º/é å­˜ç›®æ¨™" columns={[{ width: 'w-2/5', label: 'ç›®æ¨™é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }, { width: 'w-2/5', label: 'é è¨ˆé”æˆæ™‚', field: 'date', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.date} onChange={e=>onChange(e.target.value)} placeholder="å¦‚: 10æœˆ"/> }, { width: 'w-1/5', label: 'å®Œæˆ', field: 'done', render: (item, onChange) => <button onClick={()=>onChange(!item.done)} className="text-purple-600 hover:text-purple-800 transition-colors">{item.done ? <CheckSquare size={18}/> : <Square size={18} className="text-gray-300"/>}</button> }]} items={premiumGoals} setter={setPremiumGoals} defaultNewObj={{ amount: '', date: '', done: false }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
         <ArrayTable title="å›ºå®šæ”¯å‡ºæª¢è¦–" columns={[{ width: 'w-1/2', label: 'æ”¯å‡ºé …ç›®', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="é …ç›®åç¨±"/> }, { width: 'w-1/2', label: 'é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={fixedExpenses} setter={setFixedExpenses} totalLabel="åˆè¨ˆ" totalValue={totalFixed} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
         <ArrayTable title="å¯¦éš›é ç®—åˆ†é…é‡‘é¡ (å¯è‡ªå‹•åŒ¯å…¥)" columns={[{ width: 'w-1/2', label: 'é ç®—é …ç›®', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="é …ç›®åç¨±"/> }, { width: 'w-1/2', label: 'é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={budgets} setter={setBudgets} totalLabel="åˆè¨ˆ" totalValue={totalBudgets} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
         <ArrayTable title="æ¯æœˆå¯¦éš›çµé¤˜çµ±è¨ˆ (å¯è‡ªå‹•åŒ¯å…¥)" columns={[{ width: 'w-1/2', label: 'æœˆä»½', field: 'name', render: (item, onChange) => <input type="text" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.name} onChange={e=>onChange(e.target.value)} placeholder="å¦‚: 10æœˆ"/> }, { width: 'w-1/2', label: 'çµé¤˜é‡‘é¡', field: 'amount', render: (item, onChange) => <input type="number" className="w-full text-center text-sm p-1.5 border-0 focus:ring-1 bg-transparent" value={item.amount} onChange={e=>onChange(e.target.value)} placeholder="é‡‘é¡"/> }]} items={monthlyStats} setter={setMonthlyStats} totalLabel="åˆè¨ˆ" totalValue={totalMonthly} defaultNewObj={{ name: '', amount: '' }} handleUpdateArr={handleUpdateArr} handleDelArr={handleDelArr} handleAddArr={handleAddArr} />
      </div>

      <button onClick={saveHealthRecord} className="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-8">
        <Save size={24} /> å„²å­˜ã€Œ{period}ã€å¥æª¢ç´€éŒ„
      </button>

      {savedHealthRecords.length > 0 && (
        <div className="bg-white p-5 rounded-xl shadow-sm border border-purple-200 mt-8">
          <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-purple-600"/>æ­·å²å¥æª¢ç´€éŒ„</h2>
          <div className="space-y-3">
            {savedHealthRecords.map(record => (
              <div key={record.id} className="p-4 border rounded-lg bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 group hover:border-purple-300 transition-colors">
                <div>
                  <span className="font-bold text-purple-800 text-lg">{record.period}</span>
                  <div className="text-sm text-gray-500 mt-1">å»ºæª”æ™‚é–“: {new Date(record.timestamp).toLocaleDateString()} {new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
                <div className="flex items-center gap-3 w-full md:w-auto">
                  <button onClick={() => loadRecord(record)} className="flex-1 md:flex-none px-4 py-2 bg-white border border-purple-300 text-purple-700 text-sm font-bold rounded-lg hover:bg-purple-100 transition-colors flex items-center justify-center gap-1"><Download size={16}/> è¼‰å…¥</button>
                  <button onClick={() => deleteHealthRecord(record.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="åˆªé™¤ç´€éŒ„"><Trash2 size={20} /></button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// === ä¸»ç¨‹å¼ ===
export default function App() {
  const [currentView, setCurrentView] = useState('accounts'); // é è¨­é€²å…¥å¸³æˆ¶ç®¡ç†
  const [user, setUser] = useState(null);
  const [isLoaded, setIsLoaded] = useState(false);
  
  useEffect(() => {
    if (!auth) { setIsLoaded(true); return; }
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
        else await signInAnonymously(auth);
      } catch (err) { console.error("Auth error:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  const [month, setMonth] = useState(() => { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; });
  
  // æ ¸å¿ƒç‹€æ…‹ï¼šç³»çµ±ç¸½å¸³æˆ¶æ¸…å–®
  const [accounts, setAccounts] = useState([
    { id: 1, name: 'ä¸»é–‹éŠ·éŠ€è¡Œ', balance: 0 },
    { id: 2, name: 'æ•¸ä½æ”¯ä»˜(LinePay)', balance: 0 },
    { id: 3, name: 'ä¿¡ç”¨å¡(å¡«è² æ•¸)', balance: 0 },
  ]);

  const [incomes, setIncomes] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [masterDebts, setMasterDebts] = useState([{ id: 1, name: '', amount: '', note: '', dueDate: '', account: '' }]);
  const [savingsRate, setSavingsRate] = useState(30);
  const [debts, setDebts] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [fixedExpenses, setFixedExpenses] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [investments, setInvestments] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [livingExpenses, setLivingExpenses] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [balanceInventory, setBalanceInventory] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [balanceAllocation, setBalanceAllocation] = useState([{ id: 1, name: '', amount: '', account: '' }]);
  const [savedRecords, setSavedRecords] = useState([]);

  useEffect(() => {
    if (!user || !db) { setIsLoaded(true); return; }
    
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'budget');
    getDoc(docRef).then(snap => {
      if (snap.exists()) {
        const data = snap.data();
        if(data.accounts) setAccounts(JSON.parse(data.accounts));
        if(data.incomes) setIncomes(JSON.parse(data.incomes));
        if(data.masterDebts) setMasterDebts(JSON.parse(data.masterDebts));
        if(data.debts) setDebts(JSON.parse(data.debts));
        if(data.fixedExpenses) setFixedExpenses(JSON.parse(data.fixedExpenses));
        if(data.investments) setInvestments(JSON.parse(data.investments)); // è®€å–æŠ•è³‡è³‡æ–™
        if(data.livingExpenses) setLivingExpenses(JSON.parse(data.livingExpenses));
        if(data.savingsRate) setSavingsRate(data.savingsRate);
        if(data.balanceInventory) setBalanceInventory(JSON.parse(data.balanceInventory));
        if(data.balanceAllocation) setBalanceAllocation(JSON.parse(data.balanceAllocation));
      }
      setIsLoaded(true);
    }).catch(() => setIsLoaded(true));

    const recordsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords');
    const unsubscribe = onSnapshot(recordsRef, (snap) => {
      const records = [];
      snap.forEach(d => records.push({ id: d.id, ...d.data() }));
      records.sort((a, b) => b.month.localeCompare(a.month));
      setSavedRecords(records);
    }, (err) => console.error("Records snapshot error:", err));
    return () => unsubscribe();
  }, [user, db]);

  useEffect(() => {
    if (!isLoaded || !user || !db) return;
    const timer = setTimeout(() => {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'budget');
      setDoc(docRef, { accounts: JSON.stringify(accounts), incomes: JSON.stringify(incomes), masterDebts: JSON.stringify(masterDebts), debts: JSON.stringify(debts), fixedExpenses: JSON.stringify(fixedExpenses), investments: JSON.stringify(investments), livingExpenses: JSON.stringify(livingExpenses), savingsRate, balanceInventory: JSON.stringify(balanceInventory), balanceAllocation: JSON.stringify(balanceAllocation) });
    }, 1500);
    return () => clearTimeout(timer);
  }, [accounts, incomes, masterDebts, debts, fixedExpenses, investments, livingExpenses, savingsRate, balanceInventory, balanceAllocation, isLoaded, user, db]);

  const totalMasterDebt = useMemo(() => masterDebts.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [masterDebts]);
  const totalIncome = useMemo(() => incomes.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [incomes]);
  const totalDebt = useMemo(() => debts.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [debts]);
  const totalFixed = useMemo(() => fixedExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [fixedExpenses]);
  const totalInvestment = useMemo(() => investments.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [investments]);
  const totalLiving = useMemo(() => livingExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [livingExpenses]);
  const totalBalanceInv = useMemo(() => balanceInventory.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [balanceInventory]);
  const totalBalanceAlloc = useMemo(() => balanceAllocation.reduce((sum, item) => sum + (Number(item.amount) || 0), 0), [balanceAllocation]);

  // æ ¸å¿ƒé‚è¼¯æ›´æ–°ï¼šæ‰£é™¤æŠ•è³‡é‡‘é¡
  const availableBudget = totalIncome - totalDebt - totalFixed - totalInvestment;
  const savingsAmount = Math.round(availableBudget * (savingsRate / 100));
  const livingBudget = availableBudget - savingsAmount;
  const remainingLiving = livingBudget - totalLiving;
  const remainingBalanceAlloc = totalBalanceInv - totalBalanceAlloc;

  // å„å¸³æˆ¶è³‡é‡‘æµå‘èˆ‡å³æ™‚é ä¼°é¤˜é¡çµç®—
  const accountFlows = useMemo(() => {
    const flows = {};
    accounts.forEach(acc => {
      flows[acc.name] = { in: 0, out: 0, initial: Number(acc.balance) || 0 };
    });

    const addFlow = (item, type) => {
      const acc = item.account?.trim();
      if (!acc || !flows[acc]) return; 
      if (type === 'in') flows[acc].in += (Number(item.amount) || 0);
      if (type === 'out') flows[acc].out += (Number(item.amount) || 0);
    };

    incomes.forEach(i => addFlow(i, 'in'));
    debts.forEach(i => addFlow(i, 'out'));
    fixedExpenses.forEach(i => addFlow(i, 'out'));
    investments.forEach(i => addFlow(i, 'out'));
    livingExpenses.forEach(i => addFlow(i, 'out'));
    balanceAllocation.forEach(i => addFlow(i, 'out'));

    return Object.entries(flows).map(([name, data]) => ({
      name,
      initial: data.initial,
      in: data.in,
      out: data.out,
      net: data.in - data.out,
      projected: data.initial + data.in - data.out
    })).sort((a, b) => b.projected - a.projected); 
  }, [accounts, incomes, debts, fixedExpenses, investments, livingExpenses, balanceAllocation]);

  const handleAddItem = (setter, initialFields = { name: '', amount: 0, account: '' }) => setter(prev => [...prev, { id: Date.now(), ...initialFields }]);
  const handleUpdateItem = (setter, id, field, value) => setter(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
  const handleDeleteItem = (setter, id) => setter(prev => prev.filter(item => item.id !== id));

  const handleImportBonus = (bonusAmt, allocs) => {
    if (!window.confirm(`ç¢ºå®šè¦å°‡é¡å¤–æ”¶å…¥ $${bonusAmt.toLocaleString()} åŠåˆ†é…é …ç›®åŒ¯å…¥ã€Œæ¯æœˆé ç®—è¡¨ã€ä¸­å—ï¼Ÿ`)) return;
    setIncomes(prev => [...prev.filter(item => item.name || item.amount), { id: Date.now(), name: 'çé‡‘/é¡å¤–æ”¶å…¥', amount: bonusAmt, account: '' }]);
    const newDebts = []; const newFixed = [];
    allocs.forEach((alloc, idx) => {
      if (!alloc.amount || Number(alloc.amount) <= 0) return;
      const amt = Number(alloc.amount); const id = Date.now() + 10 + idx;
      if (alloc.name.includes('å‚µå‹™') || alloc.name.includes('è² å‚µ')) newDebts.push({ id, name: `[çé‡‘] ${alloc.name}`, amount: amt, account: '' });
      else newFixed.push({ id, name: `[çé‡‘] ${alloc.name}`, amount: amt, account: '' });
    });
    if (newDebts.length > 0) setDebts(prev => [...prev.filter(item => item.name || item.amount), ...newDebts]);
    if (newFixed.length > 0) setFixedExpenses(prev => [...prev.filter(item => item.name || item.amount), ...newFixed]);
    setCurrentView('budget');
  };

  const saveCurrentMonth = async () => {
    if (savedRecords.some(r => r.month === month)) if (!window.confirm(`${month} çš„ç´€éŒ„å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ`)) return;
    const newRecord = { month, totalIncome, totalDebt, totalFixed, totalInvestment, availableBudget, savingsRate, savingsAmount, livingBudget, totalLiving, totalBalanceInv, totalBalanceAlloc, timestamp: Date.now(), incomes: JSON.stringify(incomes), masterDebts: JSON.stringify(masterDebts), debts: JSON.stringify(debts), fixedExpenses: JSON.stringify(fixedExpenses), investments: JSON.stringify(investments), livingExpenses: JSON.stringify(livingExpenses), balanceInventory: JSON.stringify(balanceInventory), balanceAllocation: JSON.stringify(balanceAllocation) };
    if (user && db) {
      const existing = savedRecords.find(r => r.month === month);
      const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords');
      try {
        if (existing && existing.id) await setDoc(doc(colRef, existing.id), newRecord);
        else await setDoc(doc(colRef, `${month}-${Date.now()}`), newRecord);
      } catch (e) { console.error("Save record error:", e); }
    } else {
      setSavedRecords(prev => [...prev.filter(r => r.month !== month), { id: Date.now(), ...newRecord }].sort((a, b) => b.month.localeCompare(a.month)));
    }
  };

  const loadBudgetRecord = (record) => {
    if(!window.confirm(`ç¢ºå®šè¦è¼‰å…¥ ${record.month} çš„ç´€éŒ„å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰ç•«é¢ä¸Šæœªå„²å­˜çš„è³‡æ–™ã€‚`)) return;
    setMonth(record.month);
    if(record.savingsRate) setSavingsRate(record.savingsRate);
    if(record.incomes) setIncomes(JSON.parse(record.incomes));
    if(record.masterDebts) setMasterDebts(JSON.parse(record.masterDebts));
    if(record.debts) setDebts(JSON.parse(record.debts));
    if(record.fixedExpenses) setFixedExpenses(JSON.parse(record.fixedExpenses));
    if(record.investments) setInvestments(JSON.parse(record.investments)); // è¼‰å…¥æŠ•è³‡è³‡æ–™
    if(record.livingExpenses) setLivingExpenses(JSON.parse(record.livingExpenses));
    if(record.balanceInventory) setBalanceInventory(JSON.parse(record.balanceInventory));
    if(record.balanceAllocation) setBalanceAllocation(JSON.parse(record.balanceAllocation));
  };

  const deleteRecord = async (id) => {
    if (user && db) {
      try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'monthlyRecords', id.toString())); } catch(e) { console.error(e); }
    } else { setSavedRecords(prev => prev.filter(r => r.id !== id)); }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-gray-800 font-sans p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-6 relative">
        
        {/* Header */}
        <div className="bg-purple-100 rounded-2xl p-6 shadow-sm border border-purple-200 text-center relative overflow-hidden flex flex-col items-center justify-center">
          {user && db && (
             <div className="absolute top-4 right-4 text-green-600 flex items-center gap-1 text-xs font-bold bg-white/80 px-3 py-1.5 rounded-full shadow-sm">
               <Cloud size={14} className="animate-pulse" /> é›²ç«¯åŒæ­¥ä¸­
             </div>
          )}
          <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-300 via-pink-300 to-purple-300"></div>
          <h1 className="text-2xl md:text-3xl font-bold text-purple-900 mb-2 mt-4 md:mt-2">æ™ºèƒ½è²¡å‹™ç®¡å®¶</h1>
          <p className="text-purple-700">å€‹äººæ”¶æ”¯èˆ‡å¤šå¸³æˆ¶è³‡é‡‘åˆ†é…ç³»çµ±</p>
        </div>

        {/* åˆ†é åˆ‡æ›å°è¦½åˆ— */}
        <div className="grid grid-cols-3 md:flex md:flex-wrap bg-white rounded-xl shadow-sm border border-gray-200 p-1 mb-6 gap-1 md:gap-0">
          <button onClick={() => setCurrentView('instructions')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'instructions' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><BookOpen size={18} className="hidden sm:block" />ç³»çµ±èªªæ˜</button>
          <button onClick={() => setCurrentView('accounts')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'accounts' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-blue-50'}`}><CreditCard size={18} className="hidden sm:block" />å¸³æˆ¶ç¸½è¡¨</button>
          <button onClick={() => setCurrentView('budget')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'budget' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><LayoutDashboard size={18} className="hidden sm:block" />é ç®—åˆ†é…</button>
          <button onClick={() => setCurrentView('emergency')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'emergency' ? 'bg-pink-600 text-white shadow' : 'text-gray-500 hover:bg-pink-50'}`}><ShieldAlert size={18} className="hidden sm:block" />é å‚™é‡‘è©¦ç®—</button>
          <button onClick={() => setCurrentView('bonus')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'bonus' ? 'bg-yellow-500 text-white shadow' : 'text-gray-500 hover:bg-yellow-50'}`}><Gift size={18} className="hidden sm:block" />çé‡‘è¦åŠƒ</button>
          <button onClick={() => setCurrentView('health')} className={`py-3 text-center font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs md:text-sm lg:text-base md:flex-1 ${currentView === 'health' ? 'bg-purple-600 text-white shadow' : 'text-gray-500 hover:bg-purple-50'}`}><Activity size={18} className="hidden sm:block" />è²¡å‹™è¿½è¹¤</button>
        </div>

        {currentView === 'instructions' && <InstructionsView />}

        {currentView === 'accounts' && (
          <div className="space-y-6">
            <div className="bg-blue-50 rounded-2xl p-6 shadow-sm border border-blue-200 text-center">
               <h2 className="text-2xl font-bold text-blue-900 mb-2 flex items-center justify-center gap-2"><CreditCard size={24} /> å¸³æˆ¶èˆ‡è³‡ç”¢ç¸½è¡¨</h2>
               <p className="text-blue-700">ç®¡ç†æ‚¨çš„éŠ€è¡Œå¸³æˆ¶ã€é›»å­æ”¯ä»˜èˆ‡ä¿¡ç”¨å¡ï¼Œéš¨æ™‚æŒæ¡å³æ™‚é¤˜é¡</p>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6">
               <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 border-b pb-4">
                 <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Wallet className="text-blue-600"/> æˆ‘çš„å¸³æˆ¶æ¸…å–®</h3>
                 <div className="text-sm bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-bold shadow-inner">
                   è¡¨å®šç¸½è³‡ç”¢: ${accounts.reduce((sum, a) => sum + (Number(a.balance) || 0), 0).toLocaleString()}
                 </div>
               </div>
               
               <div className="space-y-3">
                 {accounts.map(acc => (
                   <div key={acc.id} className="flex flex-col md:flex-row gap-3 items-center p-3 border border-gray-100 rounded-lg hover:bg-blue-50/50 transition-colors">
                      <div className="w-full md:w-1/2">
                        <label className="block text-xs text-gray-500 mb-1 font-bold">å¸³æˆ¶åç¨± (æä¾›ä¸‹æ‹‰é¸å–®ä½¿ç”¨)</label>
                        <input type="text" value={acc.name} onChange={e => handleUpdateItem(setAccounts, acc.id, 'name', e.target.value)} className="w-full p-2.5 border rounded focus:ring-2 focus:ring-blue-300" placeholder="ä¾‹å¦‚: å°æ–°è–ªè½‰ã€LinePayã€ç‰å±±ä¿¡ç”¨å¡" />
                      </div>
                      <div className="w-full md:w-2/5">
                        <label className="block text-xs text-gray-500 mb-1 font-bold">ç›®å‰çœŸå¯¦é¤˜é¡ (ä¿¡ç”¨å¡æ¬ æ¬¾è«‹å¡«è² æ•¸)</label>
                        <input type="number" value={acc.balance === 0 ? 0 : (acc.balance || '')} onChange={e => handleUpdateItem(setAccounts, acc.id, 'balance', e.target.value === '' ? '' : Number(e.target.value))} className="w-full p-2.5 border rounded focus:ring-2 focus:ring-blue-300 font-bold text-gray-700" placeholder="0" />
                      </div>
                      <div className="w-full md:w-auto flex justify-end md:self-end md:mb-1">
                        <button onClick={() => handleDeleteItem(setAccounts, acc.id)} className="p-2.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20}/></button>
                      </div>
                   </div>
                 ))}
                 <button onClick={() => handleAddItem(setAccounts, { name: '', balance: 0 })} className="w-full py-4 mt-2 border-2 border-dashed border-blue-200 text-blue-600 hover:bg-blue-50 rounded-xl font-bold flex justify-center items-center gap-2 transition-colors"><Plus size={20}/> æ–°å¢å¸³æˆ¶ / è³‡ç”¢</button>
               </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="px-4 py-3 border-b bg-gray-50">
                <h3 className="font-bold text-gray-800 flex items-center gap-2"><TrendingUp size={18} className="text-green-600"/> çµåˆã€Œé ç®—è¡¨ã€ä¹‹é ä¼°å³æ™‚é¤˜é¡</h3>
              </div>
              <div className="p-2 overflow-x-auto">
                 <table className="w-full text-sm text-left min-w-[500px]">
                   <thead className="text-xs text-gray-500 bg-gray-100">
                     <tr>
                       <th className="px-4 py-3">å¸³æˆ¶åç¨±</th>
                       <th className="px-4 py-3 text-right">ç›®å‰è¨­å®šé¤˜é¡</th>
                       <th className="px-4 py-3 text-right">é ç®—è¡¨æµå…¥ (+)</th>
                       <th className="px-4 py-3 text-right">é ç®—è¡¨æµå‡º (-)</th>
                       <th className="px-4 py-3 text-right text-blue-700">é ç®—åŸ·è¡Œå¾Œé¤˜é¡</th>
                     </tr>
                   </thead>
                   <tbody>
                     {accountFlows.map(flow => (
                       <tr key={flow.name} className="border-b border-gray-50 last:border-0 hover:bg-blue-50/30">
                         <td className="px-4 py-3 font-bold text-gray-700">{flow.name || '(æœªå‘½å)'}</td>
                         <td className="px-4 py-3 text-right">${flow.initial.toLocaleString()}</td>
                         <td className="px-4 py-3 text-right text-green-600">{flow.in > 0 ? `+${flow.in.toLocaleString()}` : '-'}</td>
                         <td className="px-4 py-3 text-right text-red-500">{flow.out > 0 ? `-${flow.out.toLocaleString()}` : '-'}</td>
                         <td className={`px-4 py-3 text-right font-black text-lg ${flow.projected >= 0 ? 'text-blue-600' : 'text-red-600'}`}>${flow.projected.toLocaleString()}</td>
                       </tr>
                     ))}
                     {accountFlows.length === 0 && (
                       <tr><td colSpan="5" className="text-center py-6 text-gray-400">ç›®å‰é ç®—è¡¨ä¸­æ²’æœ‰ç´€éŒ„ä½¿ç”¨ä»»ä½•å¸³æˆ¶</td></tr>
                     )}
                   </tbody>
                 </table>
              </div>
            </div>
          </div>
        )}

        {currentView === 'budget' && (
          <>
            <div className="flex flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <div className="flex-1 min-w-[200px]">
                <label className="block text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1"><Calendar size={16} /> çµç®—æœˆä»½</label>
                <input type="month" value={month} onChange={(e) => setMonth(e.target.value)} className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300" />
              </div>
              <div className="flex-1 min-w-[200px]">
                <label className="block text-sm font-semibold text-gray-600 mb-1 flex items-center gap-1"><DollarSign size={16} /> æœ¬æœˆç¸½æ”¶å…¥</label>
                <div className="w-full p-2 border border-gray-100 bg-gray-50 rounded-lg text-lg font-bold text-purple-700">${totalIncome.toLocaleString()}</div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              <div className="lg:col-span-7 space-y-6">
                <ExpenseTable title="æœ¬æœˆæ”¶å…¥æ¸…å–®" items={incomes} setter={setIncomes} total={totalIncome} icon={DollarSign} colorClass="border-yellow-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                
                <MasterDebtTable masterDebts={masterDebts} setMasterDebts={setMasterDebts} setDebts={setDebts} setFixedExpenses={setFixedExpenses} handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} totalMasterDebt={totalMasterDebt} accounts={accounts} />
                
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                  <ExpenseTable title="å„ªå…ˆå„Ÿé‚„è² å‚µ" items={debts} setter={setDebts} total={totalDebt} icon={TrendingUp} colorClass="border-red-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                  <ExpenseTable title="å›ºå®šæ”¯å‡º" items={fixedExpenses} setter={setFixedExpenses} total={totalFixed} icon={Wallet} colorClass="border-blue-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                </div>
                
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                  <ExpenseTable title="æŠ•è³‡èˆ‡ç†è²¡" items={investments} setter={setInvestments} total={totalInvestment} icon={PieChart} colorClass="border-indigo-300" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                  <ExpenseTable title="ç”Ÿæ´»è²»åˆ†é…" items={livingExpenses} setter={setLivingExpenses} total={totalLiving} icon={Wallet} colorClass="border-green-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                </div>
              
                <div className="grid grid-cols-1 xl:grid-cols-2 gap-6 pt-6 border-t border-gray-200 mt-6">
                  <ExpenseTable title="æœˆåº•é¤˜é¡ç›¤é»" items={balanceInventory} setter={setBalanceInventory} total={totalBalanceInv} icon={Wallet} colorClass="border-indigo-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                  <ExpenseTable title="é¤˜é¡å†åˆ†é…" items={balanceAllocation} setter={setBalanceAllocation} total={totalBalanceAlloc} icon={TrendingUp} colorClass="border-teal-200" handleUpdateItem={handleUpdateItem} handleDeleteItem={handleDeleteItem} handleAddItem={handleAddItem} accounts={accounts} />
                </div>

                {accountFlows.length > 0 && (
                  <div className="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden mt-6 hidden lg:block">
                    <div className="px-4 py-3 border-b bg-blue-50 flex items-center justify-between">
                      <h3 className="font-bold flex items-center gap-2 text-blue-900"><Wallet size={18} className="text-blue-600" /> ğŸ¦ å„å¸³æˆ¶è³‡é‡‘æµå‘èˆ‡å³æ™‚é¤˜é¡</h3>
                    </div>
                    <div className="p-2 overflow-x-auto">
                      <table className="w-full text-sm text-left min-w-[500px]">
                        <thead className="text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
                          <tr><th className="px-3 py-2 w-1/4">å¸³æˆ¶åç¨±</th><th className="px-3 py-2 text-right">ç›®å‰é¤˜é¡</th><th className="px-3 py-2 text-right">é è¨ˆæ·¨è®Šå‹•</th><th className="px-3 py-2 text-right text-blue-700 font-bold">é ä¼°å³æ™‚é¤˜é¡</th></tr>
                        </thead>
                        <tbody>
                          {accountFlows.map((flow, idx) => (
                            <tr key={idx} className="border-b border-gray-50 last:border-0 hover:bg-blue-50/30 transition-colors">
                              <td className="px-3 py-2 font-bold text-gray-700">{flow.name || '(æœªé¸æ“‡)'}</td>
                              <td className="px-3 py-2 text-right">${flow.initial.toLocaleString()}</td>
                              <td className={`px-3 py-2 text-right font-bold ${flow.net > 0 ? 'text-green-600' : flow.net < 0 ? 'text-red-500' : 'text-gray-500'}`}>{flow.net > 0 ? '+' : ''}{flow.net.toLocaleString()}</td>
                              <td className={`px-3 py-2 text-right font-black ${flow.projected >= 0 ? 'text-blue-600' : 'text-red-600'}`}>${flow.projected.toLocaleString()}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>

              <div className="lg:col-span-5 space-y-6">
                <div className="bg-purple-50 p-5 rounded-xl shadow-sm border border-purple-200 sticky top-4">
                  <h2 className="text-xl font-bold text-purple-900 mb-4 border-b border-purple-200 pb-2">çµç®—è¨ˆç®—çœ‹æ¿</h2>
                  <div className="space-y-4 text-sm md:text-base">
                    <div className="bg-white p-3 rounded-lg shadow-sm">
                      <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 1: è¨ˆç®—å¯ç”¨é¡åº¦</p>
                      <div className="flex justify-between items-center mb-1"><span>ç¸½æ”¶å…¥</span><span>${totalIncome.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center text-red-500 mb-1"><span>- è² å‚µ</span><span>${totalDebt.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center text-blue-500 mb-1"><span>- å›ºå®šæ”¯å‡º</span><span>${totalFixed.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center text-indigo-500 border-b pb-2 mb-2"><span>- æŠ•è³‡ç†è²¡</span><span>${totalInvestment.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center font-bold text-purple-700 text-lg"><span>= å¯ç”¨è³‡é‡‘</span><span>${availableBudget.toLocaleString()}</span></div>
                    </div>
                    <div className="bg-white p-3 rounded-lg shadow-sm">
                      <p className="text-gray-500 mb-2 text-xs font-bold tracking-wider flex justify-between">
                        <span>STEP 2: å„²è“„ç›®æ¨™è¨­å®š</span>
                        <span className="flex items-center gap-1">åˆ†é…æ¯”ä¾‹: <input type="number" value={savingsRate} onChange={(e) => setSavingsRate(Number(e.target.value))} className="w-12 border rounded px-1 text-center"/> %</span>
                      </p>
                      <div className="flex justify-between items-center font-bold text-green-600 text-lg"><span>æ‡‰å­˜é‡‘é¡</span><span>${savingsAmount.toLocaleString()}</span></div>
                    </div>
                    <div className="bg-white p-3 rounded-lg shadow-sm">
                      <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 3: ç”Ÿæ´»è²»é¡åº¦æ ¸ç®—</p>
                      <div className="flex justify-between items-center text-purple-700 mb-1"><span>å¯ç”¨è³‡é‡‘</span><span>${availableBudget.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center text-green-600 border-b pb-2 mb-2"><span>- æ‡‰å­˜é‡‘é¡</span><span>${savingsAmount.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center font-bold text-gray-800 text-lg mb-2"><span>= å‰©é¤˜ç”Ÿæ´»è²»é¡åº¦</span><span>${livingBudget.toLocaleString()}</span></div>
                      <div className="mt-3 pt-3 border-t border-dashed border-gray-300">
                        <div className="flex justify-between items-center text-sm"><span>è¡¨æ ¼å·²åˆ†é…ä¹‹ç”Ÿæ´»è²»</span><span>${totalLiving.toLocaleString()}</span></div>
                        <div className={`flex justify-between items-center font-bold text-sm mt-1 ${remainingLiving < 0 ? 'text-red-500' : 'text-gray-500'}`}>
                          <span>æ ¸å°å·®é¡ (é€æ”¯/ç›ˆé¤˜)</span><span>${remainingLiving.toLocaleString()}</span>
                        </div>
                      </div>
                    </div>

                    <div className="bg-white p-3 rounded-lg shadow-sm">
                      <p className="text-gray-500 mb-1 text-xs font-bold tracking-wider">STEP 4: æœˆåº•çµé¤˜å†åˆ†é…</p>
                      <div className="flex justify-between items-center text-indigo-700 mb-1"><span>ç›¤é»ç¸½çµé¤˜</span><span>${totalBalanceInv.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center text-teal-600 border-b pb-2 mb-2"><span>- å·²è¨­å®šå†åˆ†é…</span><span>${totalBalanceAlloc.toLocaleString()}</span></div>
                      <div className="flex justify-between items-center font-bold text-gray-800 text-lg mb-2">
                        <span>= å°šæœªåˆ†é…çµé¤˜</span>
                        <span className={remainingBalanceAlloc < 0 ? 'text-red-500' : 'text-gray-800'}>${remainingBalanceAlloc.toLocaleString()}</span>
                      </div>
                    </div>

                    <button onClick={saveCurrentMonth} className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors mt-4">
                      <Save size={20} />å„²å­˜ {month} çµç®—æ˜ç´°
                    </button>
                  </div>
                </div>

                {accountFlows.length > 0 && (
                  <div className="bg-white rounded-xl shadow-sm border border-blue-200 overflow-hidden mt-6 block lg:hidden">
                    <div className="px-4 py-3 border-b bg-blue-50 flex items-center justify-between">
                      <h3 className="font-bold flex items-center gap-2 text-blue-900"><Wallet size={18} className="text-blue-600" /> å„å¸³æˆ¶å³æ™‚é¤˜é¡</h3>
                    </div>
                    <div className="p-2 overflow-x-auto">
                      <table className="w-full text-sm text-left">
                        <thead className="text-xs text-gray-500 bg-gray-50 border-b border-gray-100">
                          <tr><th className="px-3 py-2">å¸³æˆ¶åç¨±</th><th className="px-3 py-2 text-right">é è¨ˆè®Šå‹•</th><th className="px-3 py-2 text-right text-blue-700">é ä¼°é¤˜é¡</th></tr>
                        </thead>
                        <tbody>
                          {accountFlows.map((flow, idx) => (
                            <tr key={idx} className="border-b border-gray-50">
                              <td className="px-3 py-2 font-bold text-gray-700">{flow.name || '(æœªé¸æ“‡)'}</td>
                              <td className={`px-3 py-2 text-right font-bold ${flow.net > 0 ? 'text-green-600' : flow.net < 0 ? 'text-red-500' : 'text-gray-500'}`}>{flow.net > 0 ? '+' : ''}{flow.net.toLocaleString()}</td>
                              <td className="px-3 py-2 text-right font-black">${flow.projected.toLocaleString()}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {savedRecords.length > 0 && (
                  <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                     <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><History size={20} className="text-purple-600"/>æ­·å²çµç®—ç´€éŒ„</h2>
                    <div className="space-y-3">
                      {savedRecords.map(record => (
                        <div key={record.id} className="p-3 border rounded-lg bg-gray-50 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 group hover:border-purple-300 transition-colors">
                          <div className="w-full">
                            <div className="font-bold text-purple-700 text-lg mb-2">{record.month}</div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-x-2 gap-y-1 text-xs text-gray-600">
                              <div>ç¸½æ”¶å…¥: ${record.totalIncome.toLocaleString()}</div>
                              <div>ç¸½è² å‚µ: ${record.totalDebt.toLocaleString()}</div>
                              <div>å›ºå®šæ”¯å‡º: ${record.totalFixed.toLocaleString()}</div>
                              <div>æŠ•è³‡ç†è²¡: ${(record.totalInvestment || 0).toLocaleString()}</div>
                              <div className="font-bold text-green-600">å„²è“„: ${record.savingsAmount.toLocaleString()}</div>
                              <div className="text-gray-500">ç”Ÿæ´»è²»: ${record.totalLiving.toLocaleString()}</div>
                              {record.totalBalanceInv > 0 && (
                                <div className="col-span-2 md:col-span-3 mt-1 pt-1 border-t border-gray-100 flex justify-between font-bold text-indigo-600">
                                  <span>æœˆåº•çµé¤˜: ${record.totalBalanceInv.toLocaleString()}</span>
                                  <span>å†åˆ†é…: ${record.totalBalanceAlloc?.toLocaleString() || 0}</span>
                                </div>
                              )}
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-2 w-full xl:w-auto mt-2 xl:mt-0 pt-2 xl:pt-0 border-t xl:border-0 border-gray-200">
                            {record.incomes && ( 
                               <button onClick={() => loadBudgetRecord(record)} className="flex-1 xl:flex-none px-3 py-1.5 bg-white border border-purple-300 text-purple-700 text-sm font-bold rounded hover:bg-purple-100 transition-colors flex items-center justify-center gap-1"><Download size={14}/> è¼‰å…¥æ˜ç´°</button>
                            )}
                            <button onClick={() => deleteRecord(record.id)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash2 size={18} /></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </>
        )}
        
        {currentView === 'emergency' && <EmergencyFundView db={db} user={user} appId={appId} />}
        {currentView === 'bonus' && <BonusAllocationView db={db} user={user} appId={appId} onImport={handleImportBonus} />}
        {currentView === 'health' && <HealthCheckView db={db} user={user} appId={appId} savedMonthlyRecords={savedRecords} />}

      </div>
    </div>
  );
}
